<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Creative Juice Agency</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0e0e0f; --bg2:#141416; --bg3:#1a1a1d; --bg4:#212126;
    --border:#2a2a2f; --border2:#333338;
    --gold:#c9a84c; --gold2:#e8c96d; --gold-dim:rgba(201,168,76,0.12); --gold-dim2:rgba(201,168,76,0.22);
    --text:#e8e8ec; --text2:#9898a8; --text3:#5a5a6a;
    --green:#4caf7a; --green-dim:rgba(76,175,122,0.12);
    --red:#e05a5a; --red-dim:rgba(224,90,90,0.12);
    --blue:#5a8fd4; --blue-dim:rgba(90,143,212,0.12);
    --purple:#9a7fd4; --orange:#d47a3a; --teal:#4cbfc9;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;min-height:100vh;display:flex;}

  .sidebar{width:220px;min-height:100vh;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;position:sticky;top:0;height:100vh;overflow:hidden;}
  .logo{padding:28px 24px 24px;border-bottom:1px solid var(--border);}
  .logo-text{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;letter-spacing:0.12em;color:var(--gold);}
  .logo-sub{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.2em;color:var(--text3);text-transform:uppercase;margin-top:2px;}
  .nav{padding:16px 12px;flex:1;overflow-y:auto;}
  .nav-section{margin-bottom:24px;}
  .nav-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.18em;color:var(--text3);text-transform:uppercase;padding:0 12px;margin-bottom:6px;}
  .nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:6px;cursor:pointer;color:var(--text2);transition:all 0.15s;font-size:13px;border:1px solid transparent;}
  .nav-item:hover{background:var(--bg3);color:var(--text);}
  .nav-item.active{background:var(--gold-dim);color:var(--gold);border-color:var(--gold-dim2);}
  .nav-item svg{width:15px;height:15px;flex-shrink:0;}
  .nav-badge{margin-left:auto;background:var(--bg4);color:var(--text3);font-family:'DM Mono',monospace;font-size:10px;padding:1px 6px;border-radius:10px;}
  .nav-item.active .nav-badge{background:var(--gold-dim2);color:var(--gold);}

  .main{flex:1;min-height:100vh;display:flex;flex-direction:column;overflow:auto;}
  .topbar{background:var(--bg2);border-bottom:1px solid var(--border);padding:16px 32px;display:flex;align-items:center;gap:16px;position:sticky;top:0;z-index:100;}
  .page-title{font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:600;color:var(--text);}
  .page-sub{color:var(--text3);font-size:12px;margin-left:2px;}
  .topbar-actions{margin-left:auto;display:flex;gap:10px;align-items:center;}
  .btn{padding:8px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-family:'DM Sans',sans-serif;font-weight:500;border:1px solid var(--border2);background:var(--bg3);color:var(--text2);transition:all 0.15s;display:flex;align-items:center;gap:6px;}
  .btn:hover{background:var(--bg4);color:var(--text);}
  .btn-primary{background:var(--gold);color:#0e0e0f;border-color:var(--gold);font-weight:600;}
  .btn-primary:hover{background:var(--gold2);border-color:var(--gold2);color:#0e0e0f;}
  .btn-sm{padding:5px 11px;font-size:11px;}
  .content{padding:28px 32px;flex:1;}

  .view{display:none;} .view.active{display:block;}

  .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px;}
  .stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:20px 22px;position:relative;overflow:hidden;}
  .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--gold),transparent);}
  .stat-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.16em;text-transform:uppercase;color:var(--text3);margin-bottom:10px;}
  .stat-value{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:var(--text);line-height:1;}
  .stat-delta{font-size:11px;color:var(--green);margin-top:6px;display:flex;align-items:center;gap:4px;}

  /* CRM TABS */
  .crm-tabs{display:flex;margin-bottom:24px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;overflow:hidden;width:fit-content;}
  .crm-tab{padding:9px 22px;cursor:pointer;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);transition:all 0.15s;border:none;background:none;}
  .crm-tab.active{background:var(--gold-dim);color:var(--gold);}
  .crm-tab-content{display:none;} .crm-tab-content.active{display:block;}

  /* PIPELINE */
  .pipeline{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:28px;}
  .pipeline-col{background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden;min-width:160px;transition:border-color .15s,background .15s;}
  .pipeline-col.drag-over{border-color:var(--gold);background:rgba(201,168,76,0.05);}
  .pipeline-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
  .pipeline-stage{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.12em;text-transform:uppercase;}
  .stage-dot{width:7px;height:7px;border-radius:50%;margin-right:8px;display:inline-block;}
  .stage-count{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);background:var(--bg3);padding:2px 7px;border-radius:10px;}
  .pipeline-cards{padding:10px;display:flex;flex-direction:column;gap:8px;min-height:60px;}
  .deal-card{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:14px;cursor:grab;transition:all 0.15s;user-select:none;}
  .deal-card:hover{border-color:var(--border2);background:var(--bg4);}
  .deal-card.dragging{opacity:0.35;cursor:grabbing;transform:rotate(1deg) scale(0.97);}
  .deal-card.no-drag{cursor:default;}
  .deal-name{font-size:12px;font-weight:500;color:var(--text);margin-bottom:5px;}
  .deal-client{font-size:11px;color:var(--text3);margin-bottom:9px;}
  .deal-value{font-family:'DM Mono',monospace;font-size:13px;color:var(--gold);font-weight:500;}
  .deal-buckets{display:flex;height:3px;border-radius:2px;overflow:hidden;margin-top:9px;gap:1px;}
  .bucket-bar{height:100%;border-radius:1px;}
  .deal-meta{display:flex;align-items:center;justify-content:space-between;margin-top:9px;}
  .deal-prob{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);}
  .deal-avatar{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:600;color:#0e0e0f;}

  /* INVOICE STATUS */
  .inv-badge{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.07em;padding:3px 8px;border-radius:4px;text-transform:uppercase;display:inline-flex;align-items:center;gap:5px;}
  .inv-none{background:var(--bg4);color:var(--text3);}
  .inv-sent{background:var(--blue-dim);color:var(--blue);}
  .inv-deposit{background:rgba(212,122,58,0.15);color:var(--orange);}
  .inv-paid{background:var(--green-dim);color:var(--green);}

  /* MONTHLY */
  .month-nav{display:flex;align-items:center;gap:16px;margin-bottom:20px;}
  .month-title{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;color:var(--text);}
  .month-nav-btn{background:var(--bg3);border:1px solid var(--border2);border-radius:6px;color:var(--text2);cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;transition:all 0.15s;font-size:16px;}
  .month-nav-btn:hover{color:var(--text);background:var(--bg4);}
  .monthly-table{background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:24px;}
  .mt-head{display:grid;grid-template-columns:1fr 110px 130px 170px 130px 80px;padding:10px 20px;border-bottom:1px solid var(--border);background:var(--bg);gap:12px;}
  .mt-head span,.mt-row-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.13em;text-transform:uppercase;color:var(--text3);}
  .mt-row{display:grid;grid-template-columns:1fr 110px 130px 170px 130px 80px;padding:14px 20px;border-bottom:1px solid var(--border);gap:12px;align-items:center;transition:background 0.12s;}
  .mt-row:last-child{border-bottom:none;}
  .mt-row:hover{background:var(--bg3);}
  .month-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px;}

  /* PROJECTS */
  .projects-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:28px;}
  .project-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:20px;cursor:pointer;transition:all 0.15s;}
  .project-card:hover{border-color:var(--gold-dim2);}
  .project-name{font-family:'Cormorant Garamond',serif;font-size:16px;font-weight:600;color:var(--text);margin-bottom:4px;}
  .project-client{font-size:11px;color:var(--text3);margin-bottom:14px;}
  .project-progress{height:4px;background:var(--bg4);border-radius:2px;overflow:hidden;margin-bottom:14px;}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--gold2));border-radius:2px;}
  .project-stats{display:flex;gap:16px;}
  .project-stat{font-size:11px;color:var(--text3);}
  .project-stat strong{color:var(--text);font-weight:500;display:block;font-size:13px;font-family:'DM Mono',monospace;}
  .project-labor{margin-top:14px;padding-top:14px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
  .labor-label{font-size:11px;color:var(--text3);}
  .labor-value{font-family:'DM Mono',monospace;font-size:12px;color:var(--green);}

  /* TASKS */
  .task-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:20px;}
  .view-toggle{display:flex;background:var(--bg2);border:1px solid var(--border);border-radius:7px;overflow:hidden;}
  .view-btn{padding:7px 14px;cursor:pointer;font-size:11px;color:var(--text3);transition:all 0.15s;display:flex;align-items:center;gap:6px;font-family:'DM Mono',monospace;letter-spacing:0.05em;border:none;background:none;}
  .view-btn.active{background:var(--gold-dim);color:var(--gold);}
  .kanban{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
  .kanban-col{background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden;transition:border-color .15s,background .15s;}
  .kanban-col.drag-over{border-color:var(--gold);background:rgba(201,168,76,0.05);}
  .kanban-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
  .kanban-stage{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.1em;text-transform:uppercase;display:flex;align-items:center;gap:8px;}
  .kanban-cards{padding:10px;display:flex;flex-direction:column;gap:8px;min-height:80px;}
  .task-card{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:13px;cursor:grab;transition:all 0.15s;user-select:none;}
  .task-card:hover{border-color:var(--border2);transform:translateY(-1px);}
  .task-card.dragging{opacity:0.35;cursor:grabbing;transform:rotate(1.5deg) scale(0.97);}
  .task-title{font-size:12px;font-weight:500;color:var(--text);margin-bottom:8px;line-height:1.4;}
  .task-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
  .task-tag{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.08em;padding:2px 7px;border-radius:4px;text-transform:uppercase;}
  .task-hours{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);margin-left:auto;display:flex;align-items:center;gap:4px;}
  .task-due{font-size:10px;color:var(--text3);display:flex;align-items:center;gap:4px;}
  .task-due.overdue{color:var(--red);} .task-due.soon{color:var(--orange);}
  .hours-bar{height:3px;background:var(--bg4);border-radius:2px;overflow:hidden;margin-top:8px;}
  .hours-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--gold),var(--gold2));}

  .task-list-view{display:none;} .task-list-view.active{display:block;}
  .task-kanban-view{display:none;} .task-kanban-view.active{display:block;}
  .task-calendar-view{display:none;} .task-calendar-view.active{display:block;}

  .list-table{width:100%;border-collapse:collapse;}
  .list-table th{text-align:left;padding:10px 14px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);border-bottom:1px solid var(--border);background:var(--bg2);}
  .list-table td{padding:12px 14px;border-bottom:1px solid var(--border);font-size:12px;}
  .list-table tr:hover td{background:var(--bg2);}

  .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-radius:10px;overflow:hidden;}
  .cal-header{background:var(--bg2);padding:10px;text-align:center;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);}
  .cal-day{background:var(--bg2);min-height:90px;padding:8px;transition:background .12s,outline .12s;}
  .cal-day.drag-over{background:rgba(201,168,76,0.08);outline:2px dashed rgba(201,168,76,0.6);outline-offset:-2px;border-radius:0;}
  .cal-task{font-size:9px;padding:2px 5px;border-radius:3px;margin-bottom:2px;color:#0e0e0f;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:grab;}
  .cal-day-num{font-family:'DM Mono',monospace;font-size:11px;color:var(--text3);margin-bottom:6px;}
  .cal-day.today .cal-day-num{color:var(--gold);font-weight:600;}
  .cal-day.other-month{background:var(--bg);opacity:0.5;}

  /* PAY */
  .pay-section{margin-bottom:36px;}
  .section-title{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:600;color:var(--text);margin-bottom:6px;display:flex;align-items:baseline;gap:10px;flex-wrap:wrap;}
  .section-sub{font-size:12px;color:var(--text3);font-family:'DM Sans',sans-serif;font-weight:400;}
  .pay-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
  .pay-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:20px;position:relative;}
  .pay-card.inactive-card{opacity:0.55;border-style:dashed;}
  .pay-user{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
  .member-status-badge{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.08em;padding:2px 7px;border-radius:10px;margin-left:auto;}
  .status-active{background:var(--green-dim);color:var(--green);}
  .status-inactive{background:rgba(224,90,90,0.1);color:var(--red);}
  .team-monthly-table{background:var(--bg2);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
  .team-monthly-head{display:grid;gap:10px;padding:10px 20px;background:var(--bg);border-bottom:1px solid var(--border);}
  .team-monthly-row{display:grid;gap:10px;padding:14px 20px;border-bottom:1px solid var(--border);align-items:center;transition:background .1s;}
  .team-monthly-row:last-child{border-bottom:none;}
  .team-monthly-row:hover{background:var(--bg3);}
  .manage-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
  .manage-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:18px;position:relative;}
  .manage-card.inactive-card{opacity:0.6;border-style:dashed;}
  .manage-card-actions{display:flex;gap:8px;margin-top:14px;padding-top:12px;border-top:1px solid var(--border);}
  .team-month-nav{display:flex;align-items:center;gap:12px;margin-bottom:24px;}
  .team-month-label{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:600;color:var(--text);min-width:160px;text-align:center;}
  .user-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#0e0e0f;flex-shrink:0;}
  .user-name{font-size:13px;font-weight:500;color:var(--text);}
  .user-role{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;}
  .pay-total{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:var(--green);margin-bottom:14px;line-height:1;}
  .pay-breakdown{display:flex;flex-direction:column;gap:8px;}
  .pay-row{display:flex;align-items:center;justify-content:space-between;font-size:11px;}
  .pay-row-label{color:var(--text3);}
  .pay-row-value{font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);}
  .pay-bar{height:4px;background:var(--bg4);border-radius:2px;overflow:hidden;margin:12px 0 10px;}
  .pay-bar-fill{height:100%;border-radius:2px;}

  /* PAID TOGGLE */
  .paid-status{display:flex;align-items:center;gap:10px;margin-top:14px;padding-top:14px;border-top:1px solid var(--border);}
  .paid-toggle{position:relative;width:38px;height:21px;flex-shrink:0;}
  .paid-toggle input{opacity:0;width:0;height:0;}
  .toggle-slider{position:absolute;cursor:pointer;inset:0;background:var(--bg4);border-radius:20px;transition:0.2s;border:1px solid var(--border2);}
  .toggle-slider:before{content:"";position:absolute;height:14px;width:14px;left:3px;bottom:3px;background:var(--text3);border-radius:50%;transition:0.2s;}
  input:checked+.toggle-slider{background:rgba(76,175,122,0.18);border-color:var(--green);}
  input:checked+.toggle-slider:before{transform:translateX(17px);background:var(--green);}
  .paid-label{font-size:10px;font-family:'DM Mono',monospace;letter-spacing:0.08em;}
  .paid-label.yes{color:var(--green);}
  .paid-label.no{color:var(--text3);}

  .pay-sub-header{margin-top:20px;margin-bottom:10px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);border-top:1px solid var(--border);padding-top:16px;}

  /* BUCKETS */
  .bucket-table{background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:28px;}
  .bucket-table-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
  .bucket-table-title{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);}
  .bucket-row{display:grid;grid-template-columns:220px 70px 1fr 100px 160px;align-items:center;padding:14px 20px;border-bottom:1px solid var(--border);gap:16px;}
  .bucket-row:last-child{border-bottom:none;}
  .bucket-name-cell{display:flex;align-items:center;gap:8px;font-size:12px;font-weight:500;color:var(--text);}
  .bucket-icon{width:8px;height:8px;border-radius:2px;flex-shrink:0;}
  .bucket-pct{font-family:'DM Mono',monospace;font-size:12px;color:var(--gold);}
  .bucket-mini-bar{height:5px;background:var(--bg4);border-radius:3px;overflow:hidden;}
  .bucket-fill{height:100%;border-radius:3px;}
  .bucket-amount{font-family:'DM Mono',monospace;font-size:12px;color:var(--text2);text-align:right;}
  .bucket-assignee{font-size:11px;color:var(--text3);display:flex;align-items:center;gap:6px;}
  .bucket-special{background:var(--gold-dim);border-radius:4px;padding:1px 6px;font-size:9px;font-family:'DM Mono',monospace;color:var(--gold);letter-spacing:0.06em;}

  /* MODAL */
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.72);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
  .modal-overlay.open{display:flex;}
  .modal{background:var(--bg2);border:1px solid var(--border2);border-radius:14px;width:600px;max-height:88vh;overflow-y:auto;padding:28px;animation:slideUp 0.2s ease;}
  @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
  .modal-title{font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:600;color:var(--text);margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;}
  .modal-close{cursor:pointer;color:var(--text3);font-size:20px;line-height:1;background:none;border:none;transition:color 0.15s;}
  .modal-close:hover{color:var(--text);}
  .form-group{margin-bottom:16px;}
  .form-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);margin-bottom:6px;display:block;}
  .form-input,.form-select{width:100%;background:var(--bg3);border:1px solid var(--border2);border-radius:7px;padding:9px 12px;color:var(--text);font-size:13px;font-family:'DM Sans',sans-serif;transition:border-color 0.15s;outline:none;}
  .form-input:focus,.form-select:focus{border-color:var(--gold);}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .form-select option{background:var(--bg3);}
  .bucket-inputs{display:flex;flex-direction:column;gap:9px;}
  .bucket-input-row{display:grid;grid-template-columns:12px 1fr 70px 1fr;align-items:center;gap:10px;}
  .pct-total{font-family:'DM Mono',monospace;font-size:11px;color:var(--text3);text-align:right;margin-top:8px;}
  .pct-total.valid{color:var(--green);} .pct-total.invalid{color:var(--red);}

  .empty-state{text-align:center;padding:48px 24px;color:var(--text3);}
  .empty-title{font-size:14px;color:var(--text2);margin-bottom:6px;}
  .empty-sub{font-size:12px;}

  .notification{position:fixed;bottom:24px;right:24px;background:var(--bg3);border:1px solid var(--green);border-radius:8px;padding:12px 18px;font-size:12px;color:var(--green);z-index:2000;display:none;animation:fadeInUp 0.25s ease;font-family:'DM Mono',monospace;}
  @keyframes fadeInUp{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}

  ::-webkit-scrollbar{width:5px;height:5px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

  .priority-high{background:var(--red-dim);color:var(--red);}
  .priority-med{background:rgba(212,122,58,0.12);color:var(--orange);}
  .priority-low{background:var(--green-dim);color:var(--green);}
  .status-todo{background:var(--bg4);color:var(--text3);}
  .status-progress{background:var(--blue-dim);color:var(--blue);}
  .status-review{background:rgba(154,127,212,0.12);color:var(--purple);}
  .status-done{background:var(--green-dim);color:var(--green);}

  /* PROFIT SHARE */
  .ps-quarter-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;margin-top:32px;}
  .ps-quarter-header:first-of-type{margin-top:0;}
  .ps-quarter-label{font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:600;color:var(--text);display:flex;align-items:baseline;gap:12px;}
  .ps-quarter-sub{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);font-weight:400;}
  .ps-pool-badge{font-family:'DM Mono',monospace;font-size:11px;color:var(--green);background:var(--green-dim);padding:4px 12px;border-radius:6px;}
  .ps-member-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:8px;}
  .ps-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:18px 20px;transition:border-color 0.15s;}
  .ps-card.paid-card{border-color:rgba(76,175,122,0.35);background:rgba(76,175,122,0.03);}
  .ps-card-top{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
  .ps-name{font-size:13px;font-weight:500;color:var(--text);}
  .ps-role{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:1px;}
  .ps-pct-badge{margin-left:auto;font-family:'DM Mono',monospace;font-size:11px;color:var(--gold);background:var(--gold-dim);padding:3px 9px;border-radius:5px;flex-shrink:0;}
  .ps-amount{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:var(--green);line-height:1;margin-bottom:12px;}
  .ps-breakdown{display:flex;flex-direction:column;gap:7px;margin-bottom:14px;}
  .ps-row{display:flex;align-items:center;justify-content:space-between;font-size:11px;}
  .ps-row-label{color:var(--text3);}
  .ps-row-val{font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);}
  .ps-bar{height:4px;background:var(--bg4);border-radius:2px;overflow:hidden;margin-bottom:14px;}
  .ps-bar-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--green),#6ed9a0);}
  .ps-edit-pct{display:flex;align-items:center;gap:8px;background:var(--bg3);border:1px solid var(--border2);border-radius:6px;padding:6px 10px;margin-bottom:12px;}
  .ps-edit-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--gold);flex:1;}
  .ps-edit-input{width:60px;background:var(--bg4);border:1px solid var(--gold-dim2);border-radius:4px;padding:4px 8px;color:var(--gold);font-family:'DM Mono',monospace;font-size:12px;text-align:right;outline:none;}
  .ps-edit-input:focus{border-color:var(--gold);}
  .ps-divider{height:1px;background:var(--border);margin:28px 0;}
  .ps-summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:32px;}
  .admin-banner{background:rgba(201,168,76,0.08);border:1px solid var(--gold-dim2);border-radius:8px;padding:10px 16px;margin-bottom:24px;display:flex;align-items:center;gap:10px;font-size:12px;color:var(--gold);font-family:'DM Mono',monospace;}

  /* PROFIT SHARE - ADMIN pct warning */
  .ps-pct-warning{font-family:'DM Mono',monospace;font-size:9px;color:var(--red);margin-top:4px;display:none;}
  .ps-pct-warning.show{display:block;}
  /* EXPENSES */
  .exp-summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:28px;}
  .exp-project-block{background:var(--bg2);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:20px;}
  .exp-project-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:var(--bg);border-bottom:1px solid var(--border);}
  .exp-project-title{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:600;color:var(--text);}
  .exp-project-meta{font-size:11px;color:var(--text3);margin-top:2px;}
  .exp-project-total{text-align:right;}
  .exp-project-total-label{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.14em;text-transform:uppercase;color:var(--text3);margin-bottom:2px;}
  .exp-project-total-value{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;color:var(--red);}
  .exp-table-head{display:grid;grid-template-columns:1fr 130px 110px 100px 120px 80px 36px;gap:10px;padding:8px 20px;background:var(--bg);border-bottom:1px solid var(--border);}
  .exp-table-head span{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.13em;text-transform:uppercase;color:var(--text3);}
  .exp-row{display:grid;grid-template-columns:1fr 130px 110px 100px 120px 80px 36px;gap:10px;padding:12px 20px;border-bottom:1px solid var(--border);align-items:center;transition:background .1s;}
  .exp-row:last-child{border-bottom:none;}
  .exp-row:hover{background:var(--bg3);}
  .exp-desc{font-size:12px;font-weight:500;color:var(--text);}
  .exp-category-pill{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.06em;padding:2px 8px;border-radius:10px;display:inline-block;}
  .exp-cat-software{background:rgba(90,143,212,0.12);color:var(--blue);}
  .exp-cat-contractor{background:rgba(212,122,58,0.12);color:#d47a3a;}
  .exp-cat-assets{background:rgba(201,168,76,0.12);color:var(--gold);}
  .exp-cat-advertising{background:rgba(154,127,212,0.12);color:#9a7fd4;}
  .exp-cat-printing{background:rgba(76,191,201,0.12);color:var(--teal);}
  .exp-cat-travel{background:rgba(76,175,122,0.12);color:var(--green);}
  .exp-cat-equipment{background:rgba(224,90,90,0.12);color:var(--red);}
  .exp-cat-other{background:rgba(90,90,106,0.12);color:var(--text3);}
  .exp-ptype-badge{font-family:'DM Mono',monospace;font-size:9px;padding:3px 8px;border-radius:10px;letter-spacing:.04em;}
  .exp-ptype-company{background:rgba(76,175,122,0.1);color:var(--green);}
  .exp-ptype-reimbursement{background:rgba(224,90,90,0.1);color:var(--red);}
  .exp-amount-cell{font-family:'DM Mono',monospace;font-size:12px;color:var(--red);}
  .exp-delete-btn{background:none;border:none;cursor:pointer;color:var(--text3);padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:color .12s;}
  .exp-delete-btn:hover{color:var(--red);}
  .exp-crm-sync-badge{display:flex;align-items:center;gap:6px;font-family:'DM Mono',monospace;font-size:9px;color:var(--green);background:var(--green-dim);padding:4px 10px;border-radius:6px;}
  .exp-breakdown{display:flex;gap:16px;padding:10px 20px;border-top:1px solid var(--border);}
  .exp-breakdown-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text3);}
  .exp-breakdown-dot{width:7px;height:7px;border-radius:50%;}
  .exp-reimb-dashboard{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:24px;}
  .exp-reimb-title{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:var(--text3);margin-bottom:14px;display:flex;align-items:center;gap:8px;}
  .exp-reimb-title-dot{width:6px;height:6px;border-radius:50%;background:var(--red);}
  .exp-reimb-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
  .exp-reimb-card{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px 16px;position:relative;overflow:hidden;}
  .exp-reimb-card.all-clear{border-color:rgba(76,175,122,0.3);background:linear-gradient(135deg,rgba(76,175,122,0.04) 0%,var(--bg) 60%);}
  .exp-reimb-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--red);}
  .exp-reimb-card.all-clear::before{background:var(--green);}
  .exp-reimb-member{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
  .exp-reimb-amount{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;color:var(--red);line-height:1;margin-bottom:4px;}
  .exp-reimb-amount.clear{color:var(--green);}
  .exp-reimb-sub{font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);margin-bottom:10px;}
  .exp-reimb-items{display:flex;flex-direction:column;gap:3px;}
  .exp-reimb-item-row{display:flex;justify-content:space-between;align-items:center;font-size:10px;color:var(--text3);padding:3px 0;border-bottom:1px solid var(--border);}
  .exp-reimb-item-row:last-child{border-bottom:none;}
  .exp-reimb-item-desc{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px;}
  .exp-reimb-item-amt{font-family:'DM Mono',monospace;color:var(--red);flex-shrink:0;margin-left:8px;}
  .exp-receipt-link{display:inline-flex;align-items:center;gap:4px;font-family:'DM Mono',monospace;font-size:9px;color:var(--blue);text-decoration:none;padding:2px 7px;border-radius:4px;background:rgba(90,143,212,0.08);transition:background .12s;}
  .exp-receipt-link:hover{background:rgba(90,143,212,0.18);}
  .exp-receipt-missing{font-family:'DM Mono',monospace;font-size:9px;color:rgba(224,90,90,0.7);background:rgba(224,90,90,0.06);padding:2px 7px;border-radius:4px;}
  .exp-reimb-toggle{display:flex;align-items:center;gap:6px;cursor:pointer;}
  .exp-reimb-toggle input[type=checkbox]{accent-color:var(--green);width:14px;height:14px;cursor:pointer;}
  .exp-reimb-toggle-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.04em;}
  .exp-row-reimbursed .exp-desc{text-decoration:line-through;color:var(--text3);}
  .exp-row-reimbursed .exp-amount-cell{color:var(--text3);}
  /* update table grid to fit receipt + reimbursed columns */
  .exp-table-head{display:grid;grid-template-columns:1fr 110px 100px 90px 100px 70px 110px 70px 36px;gap:8px;padding:8px 20px;background:var(--bg);border-bottom:1px solid var(--border);}
  .exp-table-head span{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.13em;text-transform:uppercase;color:var(--text3);}
  .exp-row{display:grid;grid-template-columns:1fr 110px 100px 90px 100px 70px 110px 70px 36px;gap:8px;padding:12px 20px;border-bottom:1px solid var(--border);align-items:center;transition:background .1s;}

  .filter-pill{padding:6px 14px;border-radius:20px;cursor:pointer;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.08em;border:1px solid var(--border2);background:var(--bg2);color:var(--text3);transition:all 0.15s;}
  .filter-pill:hover{background:var(--bg3);color:var(--text2);}
  .filter-pill.active{background:var(--gold-dim);color:var(--gold);border-color:var(--gold-dim2);}
  .filter-pill.archive-pill.active{background:rgba(224,90,90,0.1);color:var(--red);border-color:rgba(224,90,90,0.25);}

  /* ===== LOGIN SCREEN ===== */
  #login-screen{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center;}
  .login-card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:40px 44px;width:420px;max-width:94vw;}
  .login-logo{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:700;letter-spacing:.14em;color:var(--gold);margin-bottom:4px;}
  .login-sub{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.2em;color:var(--text3);text-transform:uppercase;margin-bottom:32px;}
  .login-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:var(--text3);margin-bottom:10px;display:block;}
  .user-select-grid{display:flex;flex-direction:column;gap:8px;margin-bottom:24px;}
  .user-select-btn{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;cursor:pointer;transition:all .15s;text-align:left;width:100%;}
  .user-select-btn:hover{border-color:var(--gold-dim2);background:var(--bg4);}
  .user-select-btn.selected{border-color:var(--gold);background:var(--gold-dim);}
  .user-select-name{font-size:13px;font-weight:500;color:var(--text);}
  .user-select-role{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:1px;}
  .user-select-badge{margin-left:auto;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.08em;padding:3px 8px;border-radius:10px;flex-shrink:0;}
  .badge-admin{background:rgba(201,168,76,0.15);color:var(--gold);}
  .badge-member{background:var(--blue-dim);color:var(--blue);}
  .pin-row{display:flex;gap:10px;margin-bottom:8px;}
  .pin-input{flex:1;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:12px;color:var(--text);font-family:'DM Mono',monospace;font-size:18px;letter-spacing:.4em;text-align:center;outline:none;transition:border-color .15s;}
  .pin-input:focus{border-color:var(--gold);}
  .pin-hint{font-size:11px;color:var(--text3);margin-bottom:20px;font-family:'DM Mono',monospace;}
  .login-error{background:var(--red-dim);border:1px solid rgba(224,90,90,0.3);border-radius:6px;padding:8px 12px;font-size:12px;color:var(--red);margin-bottom:14px;display:none;}
  .login-error.show{display:block;}

  /* ===== ROLE BADGES IN NAV ===== */
  .role-lock{margin-left:auto;opacity:0.4;}
  .role-lock svg{width:11px;height:11px;}

  /* ===== USER CHIP IN SIDEBAR FOOTER ===== */
  .sidebar-footer{padding:14px 16px;border-top:1px solid var(--border);margin-top:auto;}
  .user-chip{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;background:var(--bg3);cursor:pointer;transition:background .15s;}
  .user-chip:hover{background:var(--bg4);}
  .user-chip-name{font-size:12px;font-weight:500;color:var(--text);flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .user-chip-role{font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);}
  .user-chip-badge{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.06em;padding:2px 6px;border-radius:8px;}

  /* ===== CRM STATS 5-col for gross revenue card ===== */
  .stats-row-5{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:28px;}
  .stat-card-gross{background:linear-gradient(135deg,rgba(201,168,76,0.06) 0%,var(--bg2) 60%);border:1px solid var(--gold-dim2);}

  /* ===== RESTRICTED OVERLAY for CRM actions ===== */
  .access-denied-inline{display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(90,90,106,0.08);border:1px dashed var(--border2);border-radius:6px;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;}
  .proj-status{display:inline-flex;align-items:center;gap:5px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.08em;text-transform:uppercase;padding:3px 9px;border-radius:12px;}
  .proj-status.active{background:var(--blue-dim);color:var(--blue);}
  .proj-status.complete{background:var(--green-dim);color:var(--green);}
  .proj-status.archived{background:rgba(90,90,106,0.15);color:var(--text3);}
  .proj-status-dot{width:5px;height:5px;border-radius:50%;background:currentColor;}

  /* PROJ MONTHLY TABLE */
  .pm-head{display:grid;grid-template-columns:1fr 120px 100px 120px 100px 120px;padding:10px 20px;border-bottom:1px solid var(--border);background:var(--bg);gap:12px;}
  .pm-head span{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.13em;text-transform:uppercase;color:var(--text3);}
  .pm-row{display:grid;grid-template-columns:1fr 120px 100px 120px 100px 120px;padding:14px 20px;border-bottom:1px solid var(--border);gap:12px;align-items:center;transition:background 0.12s;}
  .pm-row:last-child{border-bottom:none;}
  .pm-row:hover{background:var(--bg3);}

  /* ============================================================
     MOBILE NAV CHROME — hidden on desktop, shown on mobile
  ============================================================ */
  #mob-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:290;backdrop-filter:blur(3px);}
  #mob-backdrop.open{display:block;}

  #mob-topbar{display:none;position:fixed;top:0;left:0;right:0;height:54px;background:var(--bg2);border-bottom:1px solid var(--border);z-index:200;align-items:center;padding:0 14px;gap:12px;}
  #mob-menu-btn{background:none;border:none;color:var(--text2);cursor:pointer;padding:6px;display:flex;align-items:center;border-radius:6px;}
  #mob-menu-btn:hover{background:var(--bg3);}
  .mob-logo{font-family:'Cormorant Garamond',serif;font-size:19px;font-weight:700;letter-spacing:.12em;color:var(--gold);}
  #mob-page-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:var(--text3);margin-left:auto;}

  .sidebar-mobile-close{display:none;background:none;border:none;color:var(--text3);cursor:pointer;padding:8px;align-items:center;justify-content:center;margin-left:auto;}
  .sidebar-mobile-close:hover{color:var(--text);}

  /* ============================================================
     TABLET  ≤ 960px
  ============================================================ */
  @media (max-width:960px){
    /* Sidebar goes icon-only */
    .sidebar{width:64px;}
    .logo{padding:18px 0;display:flex;justify-content:center;}
    .logo-text{font-size:14px;letter-spacing:.06em;}
    .logo-sub{display:none;}
    .nav-label{display:none;}
    .nav-item{padding:10px;justify-content:center;gap:0;}
    .nav-item span:not(.nav-badge){display:none;}
    .nav-badge{display:none;}
    .role-lock{display:none;}
    .sidebar-footer{padding:10px 8px;}
    .user-chip{justify-content:center;padding:8px;}
    .user-chip-name,.user-chip-role,.user-chip-badge{display:none;}

    /* Content breathing room */
    .topbar{padding:14px 20px;}
    .content{padding:20px;}

    /* Grids: 4→2 cols */
    .stats-row,.stats-row-5,.exp-summary-grid,.ps-summary-grid{grid-template-columns:repeat(2,1fr);}
    .pipeline{grid-template-columns:repeat(3,1fr);overflow-x:auto;}
    .projects-grid,.pay-grid,.ps-member-grid,.manage-grid{grid-template-columns:repeat(2,1fr);}
    .month-summary{grid-template-columns:repeat(2,1fr);}
    .exp-reimb-grid{grid-template-columns:repeat(2,1fr);}
    .kanban{grid-template-columns:repeat(2,1fr);}
    .team-monthly-head,.team-monthly-row{grid-template-columns:1fr 90px 90px 90px 110px!important;}

    /* Monthly tables: hide less-critical columns */
    .mt-head,.mt-row{grid-template-columns:1fr 90px 110px 130px 90px 60px;}
    .pm-head,.pm-row{grid-template-columns:1fr 100px 80px 100px 80px;}

    /* Expense table: trim to key cols */
    .exp-table-head,.exp-row{grid-template-columns:1fr 90px 80px 80px 70px 32px!important;}
    .exp-table-head span:nth-child(4),.exp-row>div:nth-child(4),
    .exp-table-head span:nth-child(7),.exp-row>div:nth-child(7),
    .exp-table-head span:nth-child(8),.exp-row>div:nth-child(8){display:none;}

    /* Bucket table */
    .bucket-row{grid-template-columns:1fr 60px 1fr 80px;}
    .bucket-assignee{display:none;}
  }

  /* ============================================================
     MOBILE  ≤ 600px
  ============================================================ */
  @media (max-width:600px){
    body{display:block;}

    /* Show mobile topbar, hide desktop sidebar */
    #mob-topbar{display:flex;}
    .sidebar{
      position:fixed;top:0;left:0;bottom:0;width:260px;z-index:300;
      transform:translateX(-100%);transition:transform .25s ease;
      overflow-y:auto;
    }
    .sidebar.mob-open{transform:translateX(0);}
    .sidebar-mobile-close{display:flex;}

    /* Restore full sidebar labels when drawer is open */
    .sidebar .logo{padding:20px 20px 16px;justify-content:flex-start;}
    .sidebar .logo-text{font-size:20px;letter-spacing:.1em;}
    .sidebar .logo-sub{display:block;}
    .sidebar .nav-label{display:block;}
    .sidebar .nav-item{padding:10px 12px;justify-content:flex-start;gap:10px;}
    .sidebar .nav-item span:not(.nav-badge){display:inline;}
    .sidebar .nav-badge{display:inline;}
    .sidebar .role-lock{display:inline;}
    .sidebar .user-chip-name,.sidebar .user-chip-role{display:block;}
    .sidebar .user-chip-badge{display:inline;}
    .sidebar .user-chip{justify-content:flex-start;}
    .sidebar .sidebar-footer{padding:14px 16px;}

    /* Main content shifts down for mobile topbar */
    .main{padding-top:54px;}

    /* Topbar: stack title+actions on 2 lines */
    .topbar{padding:10px 14px;flex-wrap:wrap;gap:8px;position:relative;top:auto;}
    .page-title{font-size:17px;}
    .topbar-actions{margin-left:0;width:100%;justify-content:flex-end;flex-wrap:wrap;gap:6px;}
    .content{padding:14px;}

    /* All grids → single column */
    .stats-row,.stats-row-5,.exp-summary-grid,.ps-summary-grid,
    .projects-grid,.pay-grid,.ps-member-grid,.manage-grid,
    .month-summary,.kanban,.exp-reimb-grid{grid-template-columns:1fr!important;}

    /* Pipeline: horizontal scroll with fixed card width */
    .pipeline{
      display:flex;gap:12px;
      overflow-x:auto;padding-bottom:8px;
      scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;
    }
    .pipeline-col{min-width:220px;flex-shrink:0;scroll-snap-align:start;}

    /* Kanban: horizontal scroll too */
    .kanban{
      display:flex!important;gap:12px;
      overflow-x:auto;padding-bottom:8px;
      scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;
    }
    .kanban-col{min-width:220px;flex-shrink:0;scroll-snap-align:start;}

    /* Tabs: scroll horizontally */
    .crm-tabs{width:100%;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch;}
    .crm-tab{padding:8px 14px;font-size:9px;}

    /* Task toolbar: wrap */
    .task-toolbar{flex-wrap:wrap;gap:8px;}
    .view-toggle{flex-shrink:0;}

    /* Filter pills: scroll */
    .filter-pills-row{overflow-x:auto;white-space:nowrap;padding-bottom:4px;-webkit-overflow-scrolling:touch;}

    /* Calendar: shrink cells */
    .calendar-grid{font-size:10px;}
    .cal-day{min-height:54px;padding:4px;}
    .cal-day-num{font-size:9px;margin-bottom:2px;}
    .cal-task{font-size:8px;padding:1px 3px;}

    /* Monthly tables: show only key cols, scroll for rest */
    .monthly-table,.team-monthly-table,.bucket-table,.exp-project-block{overflow-x:auto;}
    .mt-head,.mt-row{grid-template-columns:1fr 80px 90px;min-width:340px;}
    .mt-head>*:nth-child(n+4),.mt-row>*:nth-child(n+4){display:none;}
    .pm-head,.pm-row{grid-template-columns:1fr 90px 80px;min-width:300px;}
    .pm-head>*:nth-child(n+4),.pm-row>*:nth-child(n+4){display:none;}
    .team-monthly-head,.team-monthly-row{grid-template-columns:1fr 80px 100px!important;min-width:300px;}
    .team-monthly-head>*:nth-child(n+4),.team-monthly-row>*:nth-child(n+4){display:none!important;}

    /* Expense rows: hide all but desc + amount + delete */
    .exp-table-head,.exp-row{grid-template-columns:1fr 70px 32px!important;min-width:0;}
    .exp-table-head span:nth-child(n+2):not(:nth-last-child(-n+2)),
    .exp-row>div:nth-child(n+2):not(:nth-last-child(-n+2)){display:none!important;}

    /* Bucket rows: stack */
    .bucket-row{grid-template-columns:1fr 60px;gap:8px;}
    .bucket-row>*:nth-child(n+3){display:none;}

    /* Modals: full screen sheet */
    .modal{width:100%!important;max-width:100vw;max-height:92vh;border-radius:16px 16px 0 0;position:fixed;bottom:0;left:0;right:0;animation:slideUpSheet .22s ease;}
    .modal-overlay.open{align-items:flex-end;}
    @keyframes slideUpSheet{from{transform:translateY(100%)}to{transform:translateY(0)}}

    /* Form rows: stack fields */
    .form-row{grid-template-columns:1fr!important;}

    /* Profit share grid */
    .ps-member-grid{grid-template-columns:1fr!important;}

    /* Stat values: slightly smaller */
    .stat-value{font-size:22px;}
    .pay-total{font-size:22px;}
    .ps-amount{font-size:22px;}

    /* Team monthly nav */
    .team-month-nav{flex-wrap:wrap;gap:8px;}
    .team-month-label{min-width:auto;}

    /* Notification: full width at bottom */
    .notification{left:14px;right:14px;bottom:14px;text-align:center;}

    /* Section titles wrap */
    .section-title{font-size:16px;}

    /* Reimbursement dashboard grid */
    .exp-reimb-grid{grid-template-columns:1fr!important;}

    /* Pay calculator section */
    .pay-grid{grid-template-columns:1fr!important;}
  }
</style>
</head>
<body>

<!-- ===== LOGIN SCREEN ===== -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">Creative Juice</div>
    <div class="login-sub">Creative Juice Agency · Secure Login</div>

    <span class="login-label">Select your account</span>
    <div class="user-select-grid" id="login-user-grid"><!-- populated by JS --></div>

    <span class="login-label">Enter PIN</span>
    <input class="pin-input" id="login-pin" type="password" maxlength="6" placeholder="·  ·  ·  ·" oninput="clearLoginError()" onkeydown="if(event.key==='Enter')attemptLogin()">
    <div class="pin-hint" id="pin-hint">Enter your PIN to continue</div>

    <div class="login-error" id="login-error">Incorrect PIN. Please try again.</div>

    <button class="btn btn-primary" style="width:100%;justify-content:center;padding:12px" onclick="attemptLogin()">
      Sign In
    </button>
  </div>
</div>

<!-- ===== MOBILE NAV BACKDROP ===== -->
<div id="mob-backdrop" onclick="closeMobileNav()"></div>

<!-- ===== MOBILE TOPBAR ===== -->
<header id="mob-topbar">
  <button id="mob-menu-btn" onclick="openMobileNav()" aria-label="Open menu">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
  </button>
  <span class="mob-logo">Creative Juice</span>
  <span id="mob-page-label"></span>
</header>

<nav class="sidebar" id="sidebar">
  <!-- mobile close button, hidden on desktop -->
  <button class="sidebar-mobile-close" onclick="closeMobileNav()" aria-label="Close menu">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
  </button>
  <div class="logo">
    <div class="logo-text">Creative Juice</div>
    <div class="logo-sub">Creative Juice Agency</div>
  </div>
  <div class="nav">
    <div class="nav-section">
      <div class="nav-label">Workspace</div>
      <div class="nav-item active" onclick="switchView('crm')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 3h7v7H3zM14 3h7v7h-7zM3 14h7v7H3zM14 14h7v7h-7z"/></svg>
        CRM Pipeline
        <span class="nav-badge" id="crm-badge">0</span>
      </div>
      <div class="nav-item" onclick="switchView('projects')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
        Projects
        <span class="nav-badge" id="proj-badge">0</span>
      </div>
      <div class="nav-item" onclick="switchView('tasks')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
        Tasks
        <span class="nav-badge" id="task-badge">0</span>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-label">Finance</div>
      <div class="nav-item" id="nav-pay" onclick="switchView('pay')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
        Pay Calculator
      </div>
      <div class="nav-item" id="nav-profitshare" onclick="switchView('profitshare')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17.93V18h-2v1.93A8.001 8.001 0 014.07 13H6v-2H4.07A8.001 8.001 0 0111 4.07V6h2V4.07A8.001 8.001 0 0119.93 11H18v2h1.93A8.001 8.001 0 0113 19.93z"/></svg>
        Profit Share
      </div>
      <div class="nav-item" onclick="switchView('expenses')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M2 20h20M5 20V8l7-6 7 6v12M9 20v-5h6v5"/><path d="M9 8h.01M12 8h.01M15 8h.01"/></svg>
        Expenses
      </div>
      <div class="nav-item" onclick="switchView('buckets')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
        Deal Buckets
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-label">Team</div>
      <div class="nav-item" id="nav-team" onclick="switchView('team')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M9 11a4 4 0 100-8 4 4 0 000 8zM23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
        Team Members
      </div>
    </div>
  </div>
  <div class="sidebar-footer">
    <!-- Realtime sync indicator -->
    <div id="sync-indicator" style="display:flex;align-items:center;gap:6px;padding:6px 10px 10px;opacity:0;transition:opacity 0.4s">
      <div style="width:6px;height:6px;border-radius:50%;background:var(--green);flex-shrink:0"></div>
      <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--green);letter-spacing:.08em">SYNCED</span>
    </div>
    <div class="user-chip" onclick="showLogoutConfirm()">
      <div id="nav-user-avatar" class="user-avatar" style="width:28px;height:28px;font-size:11px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;color:#0e0e0f"></div>
      <div style="flex:1;min-width:0">
        <div class="user-chip-name" id="nav-user-name">—</div>
        <div class="user-chip-role" id="nav-user-role">—</div>
      </div>
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>
    </div>
  </div>
</nav>

<div class="main">
  <!-- CRM -->
  <div id="view-crm" class="view active">
    <div class="topbar">
      <div><div class="page-title">CRM Pipeline</div><div class="page-sub">Deal tracking & fund allocation</div></div>
      <div class="topbar-actions" id="crm-topbar-actions">
        <!-- populated by renderCRM based on role -->
      </div>
    </div>
    <div class="content">
      <div class="stats-row-5" id="crm-stats"></div>
      <div class="crm-tabs">
        <button class="crm-tab active" id="tab-pipeline" onclick="setCrmTab('pipeline')">Pipeline</button>
        <button class="crm-tab" id="tab-monthly" onclick="setCrmTab('monthly')">Monthly View</button>
      </div>
      <div class="crm-tab-content active" id="tc-pipeline">
        <div class="pipeline" id="pipeline-board"></div>
      </div>
      <div class="crm-tab-content" id="tc-monthly">
        <div id="monthly-board"></div>
      </div>
    </div>
  </div>

  <!-- PROJECTS -->
  <div id="view-projects" class="view">
    <div class="topbar">
      <div><div class="page-title">Projects</div><div class="page-sub" id="proj-sub">Active engagements</div></div>
      <div class="topbar-actions">
        <button class="btn btn-primary" onclick="openProjectModal()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
          New Project
        </button>
      </div>
    </div>
    <div class="content">
      <div class="crm-tabs" style="margin-bottom:24px">
        <button class="crm-tab active" id="ptab-grid" onclick="setProjTab('grid')">All Projects</button>
        <button class="crm-tab" id="ptab-monthly" onclick="setProjTab('monthly')">Monthly View</button>
      </div>
      <!-- Status filter pills -->
      <div id="proj-filter-bar" style="display:flex;gap:8px;margin-bottom:20px;align-items:center">
        <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:var(--text3);margin-right:4px">Status</span>
        <button class="filter-pill active" id="pf-active"   onclick="setProjFilter('active')">Active</button>
        <button class="filter-pill"        id="pf-complete" onclick="setProjFilter('complete')">Complete</button>
        <button class="filter-pill"        id="pf-all"      onclick="setProjFilter('all')">All</button>
        <button class="filter-pill"        id="pf-archived" onclick="setProjFilter('archived')" style="margin-left:8px">Archived</button>
      </div>
      <div class="crm-tab-content active" id="ptc-grid">
        <div class="projects-grid" id="projects-grid"></div>
      </div>
      <div class="crm-tab-content" id="ptc-monthly">
        <div id="proj-monthly-board"></div>
      </div>
    </div>
  </div>

  <!-- TASKS -->
  <div id="view-tasks" class="view">
    <div class="topbar">
      <div><div class="page-title">Tasks</div><div class="page-sub" id="tasks-sub">All projects · All members</div></div>
      <div class="topbar-actions">
        <select class="form-select" style="width:160px;padding:7px 12px" id="task-project-filter" onchange="renderTaskView()"><option value="">All Projects</option></select>
        <select class="form-select" style="width:150px;padding:7px 12px" id="task-member-filter" onchange="renderTaskView()"><option value="">All Members</option></select>
        <button class="btn btn-primary" onclick="openTaskModal()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
          New Task
        </button>
      </div>
    </div>
    <div class="content">
      <div class="task-toolbar">
        <div class="view-toggle">
          <button class="view-btn active" id="btn-kanban" onclick="setTaskView('kanban')">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="3" width="5" height="18" rx="1"/><rect x="17" y="3" width="4" height="18" rx="1"/></svg>Kanban
          </button>
          <button class="view-btn" id="btn-list" onclick="setTaskView('list')">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>List
          </button>
          <button class="view-btn" id="btn-calendar" onclick="setTaskView('calendar')">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>Calendar
          </button>
        </div>
      </div>
      <div class="task-kanban-view active" id="task-kanban"></div>
      <div class="task-list-view" id="task-list"></div>
      <div class="task-calendar-view" id="task-calendar"></div>
    </div>
  </div>

  <!-- PAY -->
  <div id="view-pay" class="view">
    <div class="topbar">
      <div><div class="page-title">Pay Calculator</div><div class="page-sub">Production pool (hours-based) + Finders Fee & PM Fee assignments</div></div>
      <div class="topbar-actions">
        <select class="form-select" style="width:200px;padding:7px 12px" id="pay-project-filter" onchange="renderPayView()"><option value="">All Projects</option></select>
      </div>
    </div>
    <div class="content">
      <!-- Pay filter bar -->
      <div style="display:flex;gap:8px;margin-bottom:24px;align-items:center;flex-wrap:wrap">
        <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:var(--text3);margin-right:4px">Project Status</span>
        <button class="filter-pill active" id="payf-all"      onclick="setPayFilter('all')">All Active</button>
        <button class="filter-pill"        id="payf-complete" onclick="setPayFilter('complete')">Complete</button>
        <button class="filter-pill"        id="payf-active"   onclick="setPayFilter('active')">In Progress</button>
        <button class="filter-pill"        id="payf-archived" onclick="setPayFilter('archived')" style="margin-left:8px">Archived</button>
      </div>
      <div id="pay-content"></div>
    </div>
  </div>

  <!-- PROFIT SHARE -->
  <div id="view-profitshare" class="view">
    <div class="topbar">
      <div><div class="page-title">Profit Share</div><div class="page-sub">Distribution from completed & collected deals</div></div>
      <div class="topbar-actions" id="profitshare-topbar-actions">
        <!-- populated by renderProfitShareView based on role -->
      </div>
    </div>
    <div class="content"><div id="profitshare-content"></div></div>
  </div>

  <!-- EXPENSES -->
  <div id="view-expenses" class="view">
    <div class="topbar">
      <div>
        <div class="page-title">Expenses</div>
        <div class="page-sub" id="exp-sub">All project expenses · synced to CRM</div>
      </div>
      <div class="topbar-actions">
        <select class="form-select" id="exp-proj-filter" onchange="renderExpensesView()" style="width:180px;padding:7px 12px;font-size:12px">
          <option value="">All Projects</option>
        </select>
        <button class="btn btn-primary" onclick="openExpenseModal()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
          Add Expense
        </button>
      </div>
    </div>
    <div class="content"><div id="expenses-content"></div></div>
  </div>

  <!-- BUCKETS -->
  <div id="view-buckets" class="view">
    <div class="topbar"><div><div class="page-title">Deal Buckets</div><div class="page-sub">Fund allocation breakdown per deal</div></div></div>
    <div class="content"><div id="buckets-content"></div></div>
  </div>

  <!-- TEAM -->
  <div id="view-team" class="view">
    <div class="topbar">
      <div><div class="page-title">Team Members</div><div class="page-sub" id="team-sub">Earnings & profiles</div></div>
      <div class="topbar-actions" id="team-topbar-actions">
        <!-- populated by renderTeamView -->
      </div>
    </div>
    <div class="content">
      <div class="crm-tabs" style="margin-bottom:24px">
        <button class="crm-tab active" id="ttab-overview" onclick="setTeamTab('overview')">Overview</button>
        <button class="crm-tab" id="ttab-monthly" onclick="setTeamTab('monthly')">Monthly Earnings</button>
        <button class="crm-tab" id="ttab-manage" onclick="setTeamTab('manage')" id="ttab-manage">Manage Profiles</button>
      </div>
      <div id="team-content"></div>
    </div>
  </div>
</div>

<!-- DEAL MODAL -->
<div class="modal-overlay" id="deal-modal">
  <div class="modal">
    <div class="modal-title">New Deal<button class="modal-close" onclick="closeModal('deal-modal')">✕</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Deal Name</label><input class="form-input" id="d-name" placeholder="Campaign Rebrand 2025"></div>
      <div class="form-group"><label class="form-label">Client</label><input class="form-input" id="d-client" placeholder="Acme Corp"></div>
    </div>
    <!-- Revenue fields -->
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Gross Revenue ($)</label>
        <input class="form-input" id="d-value" type="number" placeholder="25000" oninput="updateNetRevPreview()">
      </div>
      <div class="form-group">
        <label class="form-label">Expenses ($)</label>
        <input class="form-input" id="d-expenses" type="number" placeholder="0" min="0" oninput="updateNetRevPreview()">
      </div>
    </div>
    <!-- Net revenue display -->
    <div id="d-net-preview" style="display:flex;align-items:center;justify-content:space-between;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:11px 16px;margin-bottom:16px">
      <div>
        <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:var(--text3);margin-bottom:2px">Net Revenue</div>
        <div style="font-size:11px;color:var(--text3)" id="d-net-formula">Gross − Expenses</div>
      </div>
      <div id="d-net-value" style="font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:600;color:var(--gold);line-height:1">$0</div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Close Month</label><input class="form-input" id="d-closedate" type="month"></div>
      <div class="form-group">
        <label class="form-label">Stage</label>
        <select class="form-select" id="d-stage" onchange="toggleInvoiceStatus()">
          <option value="Lead">Lead</option>
          <option value="Qualified">Qualified</option>
          <option value="Proposal">Proposal</option>
          <option value="Negotiation">Negotiation</option>
          <option value="Closed Won">Closed Won</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Deal Owner</label><select class="form-select" id="d-owner"></select></div>
      <div class="form-group" id="d-invoice-group" style="display:none">
        <label class="form-label">Invoice Status</label>
        <select class="form-select" id="d-invoice">
          <option value="none">Not Invoiced</option>
          <option value="sent">Invoice Sent</option>
          <option value="deposit">Deposit Collected</option>
          <option value="paid">Paid in Full</option>
        </select>
      </div>
    </div>
    <div class="form-group" id="d-collected-group">
      <label class="form-label" style="display:flex;align-items:center;gap:8px">
        Amount Collected ($)
        <span style="font-family:'DM Mono',monospace;font-size:8px;color:var(--text3);background:var(--bg3);padding:2px 7px;border-radius:3px">Deposits, partials, etc.</span>
      </label>
      <input class="form-input" id="d-collected" type="number" placeholder="0" min="0">
    </div>
    <div class="form-group">
      <label class="form-label" style="margin-bottom:10px">Fund Allocation — applied to Net Revenue (must total 100%)</label>
      <div style="display:grid;grid-template-columns:12px 1fr 60px 1fr;gap:8px;padding:0 2px;margin-bottom:6px">
        <span></span>
        <span style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">Bucket</span>
        <span style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3);text-align:center">%</span>
        <span style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">Assigned To</span>
      </div>
      <div class="bucket-inputs" id="deal-bucket-inputs"></div>
      <div class="pct-total" id="pct-total">Total: 0%</div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn" onclick="closeModal('deal-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveDeal()">Save Deal</button>
    </div>
  </div>
</div>

<!-- PROJECT MODAL -->
<div class="modal-overlay" id="project-modal">
  <div class="modal">
    <div class="modal-title">New Project<button class="modal-close" onclick="closeModal('project-modal')">✕</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Project Name</label><input class="form-input" id="p-name" placeholder="Brand Identity Refresh"></div>
      <div class="form-group"><label class="form-label">Linked Deal</label><select class="form-select" id="p-deal"><option value="">No Deal</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Start Date</label><input class="form-input" id="p-start" type="date"></div>
      <div class="form-group"><label class="form-label">End Date</label><input class="form-input" id="p-end" type="date"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Status</label>
      <select class="form-select" id="p-status">
        <option value="active">Active</option>
        <option value="complete">Complete</option>
      </select>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn" onclick="closeModal('project-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveProject()">Save Project</button>
    </div>
  </div>
</div>

<!-- TASK MODAL -->
<div class="modal-overlay" id="task-modal">
  <div class="modal">
    <div class="modal-title">New Task<button class="modal-close" onclick="closeModal('task-modal')">✕</button></div>
    <div class="form-group"><label class="form-label">Task Title</label><input class="form-input" id="t-title" placeholder="Design homepage mockup"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Project</label><select class="form-select" id="t-project" onchange="updateTaskPayPreview()"></select></div>
      <div class="form-group"><label class="form-label">Assigned To</label><select class="form-select" id="t-assignee"></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Due Date</label><input class="form-input" id="t-due" type="date"></div>
      <div class="form-group"><label class="form-label">Priority</label>
        <select class="form-select" id="t-priority">
          <option value="low">Low</option><option value="med" selected>Medium</option><option value="high">High</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Total Hours Allocated</label><input class="form-input" id="t-est" type="number" placeholder="8" step="0.5" min="0" oninput="updateTaskPayPreview()"></div>
      <div class="form-group"><label class="form-label">Status</label>
        <select class="form-select" id="t-status">
          <option value="todo">To Do</option><option value="progress">In Progress</option><option value="review">In Review</option><option value="done">Done</option>
        </select>
      </div>
    </div>
    <!-- Pay preview -->
    <div id="t-pay-preview" style="display:none;align-items:center;justify-content:space-between;background:var(--green-dim);border:1px solid rgba(76,175,122,0.25);border-radius:8px;padding:12px 16px;margin-top:4px">
      <div>
        <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:var(--green);margin-bottom:3px">Estimated Task Pay</div>
        <div id="t-pay-detail" style="font-size:11px;color:var(--text3)"></div>
      </div>
      <div id="t-pay-amount" style="font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:600;color:var(--green);line-height:1"></div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;align-items:center">
      <div id="t-delete-wrap" style="display:none;margin-right:auto">
        <button class="btn" style="color:var(--red);border-color:rgba(224,90,90,0.35);gap:6px" onclick="deleteTask()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a1 1 0 011-1h6a1 1 0 011 1v2"/></svg>
          Delete Task
        </button>
      </div>
      <button class="btn" onclick="closeModal('task-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
    </div>
  </div>
</div>

<!-- TEAM MODAL -->
<div class="modal-overlay" id="team-modal">
  <div class="modal">
    <div class="modal-title">Add Team Member<button class="modal-close" onclick="closeModal('team-modal')">✕</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="tm-name" placeholder="Kyle Harries"></div>
      <div class="form-group"><label class="form-label">Role / Title</label><input class="form-input" id="tm-role" placeholder="Creative Director"></div>
    </div>
    <div class="form-group" id="tm-pin-group">
      <label class="form-label" style="display:flex;align-items:center;gap:8px">PIN
        <span id="tm-pin-hint" style="font-family:'DM Mono',monospace;font-size:8px;color:var(--text3)">Required for new members · Leave blank to keep current</span>
      </label>
      <input class="form-input" id="tm-pin" type="password" placeholder="4–6 digit PIN" maxlength="6" autocomplete="new-password">
    </div>
    <div class="form-group" id="tm-ps-group">
      <label class="form-label" style="display:flex;align-items:center;gap:8px">
        Profit Share %
        <span style="background:var(--gold-dim);color:var(--gold);font-family:'DM Mono',monospace;font-size:8px;padding:2px 7px;border-radius:3px;letter-spacing:.1em">ADMIN ONLY</span>
      </label>
      <input class="form-input" id="tm-ps" type="number" placeholder="0" min="0" max="100" step="0.5" value="0">
    </div>
    <!-- Access level — admin only -->
    <div class="form-group" id="tm-authrole-group" style="display:none">
      <label class="form-label" style="display:flex;align-items:center;gap:8px">
        Access Level
        <span style="background:var(--gold-dim);color:var(--gold);font-family:'DM Mono',monospace;font-size:8px;padding:2px 7px;border-radius:3px;letter-spacing:.1em">ADMIN ONLY</span>
      </label>
      <div style="display:flex;gap:10px;margin-top:6px">
        <label style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;cursor:pointer;flex:1;transition:all .15s">
          <input type="radio" name="tm-authrole" id="tm-authrole-admin" value="admin" style="accent-color:var(--gold)">
          <div>
            <div style="font-size:12px;font-weight:500;color:var(--text)">Admin</div>
            <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace">Full access</div>
          </div>
        </label>
        <label style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;cursor:pointer;flex:1;transition:all .15s">
          <input type="radio" name="tm-authrole" id="tm-authrole-class_a" value="class_a" style="accent-color:var(--blue)">
          <div>
            <div style="font-size:12px;font-weight:500;color:var(--text)">Class A</div>
            <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace">Full access, no team mgmt</div>
          </div>
        </label>
        <label style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;cursor:pointer;flex:1;transition:all .15s">
          <input type="radio" name="tm-authrole" id="tm-authrole-class_b" value="class_b" checked style="accent-color:var(--green)">
          <div>
            <div style="font-size:12px;font-weight:500;color:var(--text)">Class B</div>
            <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace">Add & edit, no delete</div>
          </div>
        </label>
        <label style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;cursor:pointer;flex:1;transition:all .15s">
          <input type="radio" name="tm-authrole" id="tm-authrole-va" value="va" style="accent-color:var(--text3)">
          <div>
            <div style="font-size:12px;font-weight:500;color:var(--text)">VA</div>
            <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace">Add & edit, no delete</div>
          </div>
        </label>
      </div>
    </div>
    <!-- Active/inactive toggle — admin only, shown when editing -->
    <div class="form-group" id="tm-active-group" style="display:none">
      <label class="form-label">Status</label>
      <div style="display:flex;gap:10px;margin-top:6px">
        <label style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;cursor:pointer;flex:1;transition:all .15s">
          <input type="radio" name="tm-active" id="tm-active-yes" value="active" checked style="accent-color:var(--green)">
          <div>
            <div style="font-size:12px;font-weight:500;color:var(--text)">Active</div>
            <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace">Included in earnings & tasks</div>
          </div>
        </label>
        <label style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;cursor:pointer;flex:1;transition:all .15s">
          <input type="radio" name="tm-active" id="tm-active-no" value="inactive" style="accent-color:var(--red)">
          <div>
            <div style="font-size:12px;font-weight:500;color:var(--text)">Inactive</div>
            <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace">Hidden from active views</div>
          </div>
        </label>
      </div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;align-items:center">
      <div id="tm-delete-wrap" style="display:none;margin-right:auto">
        <button class="btn" style="color:var(--red);border-color:rgba(224,90,90,0.35)" onclick="deleteTeamMember()">Remove Member</button>
      </div>
      <button class="btn" onclick="closeModal('team-modal')">Cancel</button>
      <button class="btn btn-primary" id="tm-save-btn" onclick="saveTeamMember()">Add Member</button>
    </div>
  </div>
</div>

<!-- EXPENSE MODAL -->
<div class="modal-overlay" id="expense-modal">
  <div class="modal">
    <div class="modal-title">Add Expense<button class="modal-close" onclick="closeModal('expense-modal')">✕</button></div>
    <div class="form-row">
      <div class="form-group" style="flex:2">
        <label class="form-label">Description</label>
        <input class="form-input" id="exp-desc" placeholder="Stock photography license">
      </div>
      <div class="form-group">
        <label class="form-label">Amount ($)</label>
        <input class="form-input" id="exp-amount" type="number" placeholder="0.00" min="0" step="0.01">
      </div>
    </div>
    <!-- Receipt URL — required -->
    <div class="form-group">
      <label class="form-label" style="display:flex;align-items:center;gap:7px">
        Receipt URL
        <span style="font-family:'DM Mono',monospace;font-size:8px;color:var(--red);background:rgba(224,90,90,0.1);padding:1px 6px;border-radius:3px;letter-spacing:.06em">REQUIRED</span>
      </label>
      <div style="position:relative">
        <svg style="position:absolute;left:12px;top:50%;transform:translateY(-50%);pointer-events:none" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.7"/></svg>
        <input class="form-input" id="exp-receipt" type="url" placeholder="https://drive.google.com/receipt-123" style="padding-left:34px">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Project</label>
        <select class="form-select" id="exp-project"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Category</label>
        <select class="form-select" id="exp-category">
          <option value="software">Software / Subscriptions</option>
          <option value="contractor">Contractor / Freelancer</option>
          <option value="assets">Assets / Licenses</option>
          <option value="advertising">Advertising / Media</option>
          <option value="printing">Printing / Production</option>
          <option value="travel">Travel</option>
          <option value="equipment">Equipment</option>
          <option value="other">Other</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Date</label>
        <input class="form-input" id="exp-date" type="date">
      </div>
      <div class="form-group">
        <label class="form-label">Submitted By</label>
        <select class="form-select" id="exp-submitted-by"></select>
      </div>
    </div>
    <!-- Payment type toggle -->
    <div class="form-group">
      <label class="form-label">Payment Method</label>
      <div style="display:flex;gap:10px;margin-top:6px">
        <label style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;cursor:pointer;flex:1;transition:all .15s" id="ptype-company-lbl">
          <input type="radio" name="exp-ptype" id="ptype-company" value="company" checked style="accent-color:var(--gold)">
          <div>
            <div style="font-size:12px;font-weight:500;color:var(--text)">Company Card</div>
            <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace">Charged to agency</div>
          </div>
        </label>
        <label style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;cursor:pointer;flex:1;transition:all .15s" id="ptype-reimb-lbl">
          <input type="radio" name="exp-ptype" id="ptype-reimb" value="reimbursement" style="accent-color:var(--gold)">
          <div>
            <div style="font-size:12px;font-weight:500;color:var(--text)">Reimbursement</div>
            <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace">Employee paid out-of-pocket</div>
          </div>
        </label>
      </div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn" onclick="closeModal('expense-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveExpense()">Save Expense</button>
    </div>
  </div>
</div>

<div class="notification" id="notif"></div>

<script>
// ============================================================
//  CONSTANTS & STATE
// ============================================================
const AVATAR_COLORS=['#c9a84c','#4caf7a','#5a8fd4','#e05a5a','#9a7fd4','#d47a3a','#4cbfc9','#c94c8a'];
const DEFAULT_BUCKETS=[
  {name:'Production Pool',    color:'#c9a84c',pct:60,  isPersonal:false},
  {name:'Profit Share',       color:'#4caf7a',pct:17.5,isPersonal:false},
  {name:'Finders Fee',        color:'#5a8fd4',pct:5,   isPersonal:true},
  {name:'Operations Account', color:'#9a7fd4',pct:10,  isPersonal:false},
  {name:'Project Manager Fee',color:'#d47a3a',pct:7.5, isPersonal:true},
];
const STAGES=['Lead','Qualified','Proposal','Negotiation','Closed Won'];
const STAGE_COLORS=['#5a5a6a','#5a8fd4','#c9a84c','#d47a3a','#4caf7a'];
const INV_LBL={none:'Not Invoiced',sent:'Invoice Sent',deposit:'Deposit Collected',paid:'Paid in Full'};
const INV_CLS={none:'inv-none',sent:'inv-sent',deposit:'inv-deposit',paid:'inv-paid'};
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];

function uid(){return Math.random().toString(36).substr(2,9);}
function copyBuckets(){return DEFAULT_BUCKETS.map(b=>({...b,assignedTo:''}));}

// Net revenue = gross revenue minus expenses. All bucket/pay calculations use this.
function netRev(deal){
  const gross=deal.value||0;
  const exp=deal.expenses||0;
  return Math.max(0,gross-exp);
}

function updateNetRevPreview(){
  const gross=parseFloat(document.getElementById('d-value')?.value)||0;
  const exp=parseFloat(document.getElementById('d-expenses')?.value)||0;
  const net=Math.max(0,gross-exp);
  const el=document.getElementById('d-net-value');
  const fl=document.getElementById('d-net-formula');
  if(el) el.textContent=fmt(net);
  if(fl) fl.textContent=gross||exp?`${fmt(gross)} − ${fmt(exp)}`:'Gross − Expenses';
  const preview=document.getElementById('d-net-preview');
  if(preview) preview.style.borderColor=net<gross&&exp>0?'rgba(224,90,90,0.3)':'var(--border2)';
}

let state={
  deals:[],projects:[],tasks:[],payStatus:{},profitSharePaidStatus:{},
  expenses:[],
  isAdmin:false,
  team:[
    {id:uid(),name:'Kyle Harries', role:'Creative Director',color:AVATAR_COLORS[0],profitSharePct:40,active:true},
    {id:uid(),name:'Nathan Blumberg',    role:'Lead Designer',    color:AVATAR_COLORS[1],profitSharePct:35,active:true},
    {id:uid(),name:'Blaise Freeman',  role:'Copywriter',       color:AVATAR_COLORS[2],profitSharePct:25,active:true},
  ],
  taskView:'kanban',crmTab:'pipeline',monthOffset:0,currentPage:'crm',
  projectTab:'grid',projMonthOffset:0,projStatusFilter:'active',
  payStatusFilter:'all',archivedProjects:{},
  teamTab:'overview',teamMonthOffset:0,
};

// ============================================================
//  AUTH
// ============================================================
// User registry — linked to team members by name after seed
// PIN is stored plaintext here for demo purposes
// ============================================================
//  CONFIG  — set these to your deployed values
// ============================================================
const API_BASE        = window.CJ_API_BASE        || '';          // e.g. 'https://cj-agency.vercel.app'
const SUPABASE_URL    = window.CJ_SUPABASE_URL    || '';          // e.g. 'https://xxxx.supabase.co'
const SUPABASE_ANON   = window.CJ_SUPABASE_ANON   || '';          // anon/public key only

// ============================================================
//  API HELPER
// ============================================================
let _authToken = null;

async function api(method, path, body) {
  const opts = {
    method,
    headers: { 'Content-Type': 'application/json' },
  };
  if (_authToken) opts.headers['Authorization'] = 'Bearer ' + _authToken;
  if (body !== undefined) opts.body = JSON.stringify(body);
  const res = await fetch(API_BASE + '/api' + path, opts);
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(data.error || 'API error ' + res.status);
  return data;
}

// ============================================================
//  AUTH
// ============================================================
let auth = { user: null, role: null };
let loginTeamMembers = [];    // loaded from API for login screen
let loginSelectedId  = null;

// ============================================================
//  PERMISSION HELPERS
//  Roles: 'admin' | 'class_a' | 'class_b' | 'va'
// ============================================================
const can = {
  // Only admin can manage team profiles and profit share %
  manageTeam:       () => auth.role === 'admin',
  // Only admin can change invoice status or mark pay/profit share paid
  markPaid:         () => auth.role === 'admin',
  // Admin and Class A can delete
  delete:           () => auth.role === 'admin' || auth.role === 'class_a',
  // Admin, Class A, Class B, VA can all create and edit
  edit:             () => !!auth.role,
  // Admin, Class A, VA can see Pay Calculator and Profit Share
  viewFinance:      () => auth.role === 'admin' || auth.role === 'class_a' || auth.role === 'va',
  // Only admin can see profit share paid toggles and edit % inline
  adminFinance:     () => auth.role === 'admin',
};

async function initLogin() {
  // Show loading state
  const grid = document.getElementById('login-user-grid');
  grid.innerHTML = '<div style="color:var(--text3);font-size:12px;padding:12px 0">Loading team…</div>';

  try {
    // Load team members (public endpoint — no auth required)
    const res = await fetch(API_BASE + '/api/team');
    loginTeamMembers = await res.json();
  } catch(e) {
    grid.innerHTML = '<div style="color:var(--red);font-size:12px;padding:12px 0">Could not reach server. Check your connection.</div>';
    return;
  }

  grid.innerHTML = loginTeamMembers.map(u => `
    <button class="user-select-btn" id="ubtn-${u.id}" onclick="selectLoginUser('${u.id}')">
      <div class="user-avatar" style="background:${u.color};width:30px;height:30px;font-size:11px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#0e0e0f;flex-shrink:0">${u.name.split(' ').map(n=>n[0]).join('')}</div>
      <div>
        <div class="user-select-name">${u.name}</div>
        <div class="user-select-role">${u.authRole === 'admin' ? 'Administrator' : 'Team Member'}</div>
      </div>
      <span class="user-select-badge ${u.authRole === 'admin' ? 'badge-admin' : 'badge-member'}">${u.authRole.toUpperCase()}</span>
    </button>`).join('');

  if (loginTeamMembers.length > 0) selectLoginUser(loginTeamMembers[0].id);
}

function selectLoginUser(id) {
  loginSelectedId = id;
  document.querySelectorAll('.user-select-btn').forEach(b => b.classList.remove('selected'));
  const btn = document.getElementById('ubtn-' + id);
  if (btn) btn.classList.add('selected');
  document.getElementById('login-pin').value = '';
  clearLoginError();
  const u = loginTeamMembers.find(x => x.id === id);
  document.getElementById('pin-hint').textContent = `Enter PIN for ${u ? u.name : 'selected user'}`;
}

function clearLoginError() {
  document.getElementById('login-error').classList.remove('show');
}

async function attemptLogin() {
  const pin = document.getElementById('login-pin').value;
  if (!loginSelectedId) {
    document.getElementById('login-error').textContent = 'Please select an account.';
    document.getElementById('login-error').classList.add('show');
    return;
  }

  const loginBtn = document.querySelector('#login-screen .btn-primary');
  if (loginBtn) { loginBtn.textContent = 'Signing in…'; loginBtn.disabled = true; }

  try {
    const { token, member } = await api('POST', '/auth/login', { memberId: loginSelectedId, pin });
    _authToken = token;
    auth.user  = member;
    auth.role  = member.authRole;  // 'admin' | 'class_a' | 'class_b' | 'va'
    state.isAdmin = (member.authRole === 'admin');

    // Load all data from the server
    await bootstrapState();
    // Start realtime
    startRealtime();

    document.getElementById('login-screen').style.display = 'none';
    updateNavChip();
    renderPage(state.currentPage);
  } catch(e) {
    document.getElementById('login-error').textContent = e.message === 'Incorrect PIN' ? 'Incorrect PIN. Please try again.' : 'Login failed — ' + e.message;
    document.getElementById('login-error').classList.add('show');
    document.getElementById('login-pin').value = '';
    document.getElementById('login-pin').focus();
  } finally {
    if (loginBtn) { loginBtn.textContent = 'Sign In'; loginBtn.disabled = false; }
  }
}

// ============================================================
//  BOOTSTRAP — load all data from API on login
// ============================================================
async function bootstrapState() {
  const data = await api('GET', '/bootstrap');
  state.team                  = data.team;
  state.deals                 = data.deals;
  state.projects              = data.projects;
  state.tasks                 = data.tasks;
  state.expenses              = data.expenses;
  state.payStatus             = data.payStatus || {};
  state.profitSharePaidStatus = data.profitSharePaidStatus || {};
  // archivedProjects derived from projects.archived flag
  state.archivedProjects = {};
  state.projects.forEach(p => { if (p.archived) state.archivedProjects[p.id] = true; });
  updateBadges();
}

// ============================================================
//  REALTIME — Supabase subscriptions push DB changes to all clients
// ============================================================
let _realtimeChannel = null;

function startRealtime() {
  if (!SUPABASE_URL || !SUPABASE_ANON) return; // skip if not configured

  // Dynamically load Supabase JS client
  if (!window.supabase) {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
    script.onload = () => _subscribeRealtime();
    document.head.appendChild(script);
  } else {
    _subscribeRealtime();
  }
}

function _subscribeRealtime() {
  const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  _realtimeChannel = client
    .channel('cj-agency-changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'deals' },           () => _rtRefresh('deals'))
    .on('postgres_changes', { event: '*', schema: 'public', table: 'projects' },        () => _rtRefresh('projects'))
    .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' },           () => _rtRefresh('tasks'))
    .on('postgres_changes', { event: '*', schema: 'public', table: 'expenses' },        () => _rtRefresh('expenses'))
    .on('postgres_changes', { event: '*', schema: 'public', table: 'team_members' },    () => _rtRefresh('team'))
    .on('postgres_changes', { event: '*', schema: 'public', table: 'pay_status' },      () => _rtRefresh('payStatus'))
    .on('postgres_changes', { event: '*', schema: 'public', table: 'profit_share_status' }, () => _rtRefresh('psStatus'))
    .subscribe();
}

// Debounce refreshes so rapid changes don't cause multiple re-renders
const _rtTimers = {};
function _rtRefresh(table) {
  clearTimeout(_rtTimers[table]);
  _rtTimers[table] = setTimeout(async () => {
    try {
      await _rtPullTable(table);
    } catch(e) {
      console.warn('Realtime refresh failed for', table, e);
    }
  }, 200);
}

async function _rtPullTable(table) {
  switch(table) {
    case 'deals': {
      const data = await api('GET', '/deals');
      state.deals = data;
      if (state.currentPage === 'crm') renderCRM();
      break;
    }
    case 'projects': {
      const data = await api('GET', '/projects');
      state.projects = data;
      state.archivedProjects = {};
      data.forEach(p => { if (p.archived) state.archivedProjects[p.id] = true; });
      if (state.currentPage === 'projects') renderProjects();
      break;
    }
    case 'tasks': {
      const data = await api('GET', '/tasks');
      state.tasks = data;
      if (state.currentPage === 'tasks') renderTaskView();
      break;
    }
    case 'expenses': {
      const data = await api('GET', '/expenses');
      state.expenses = data;
      // Re-sync deal expenses in local state
      state.projects.forEach(proj => {
        const deal = state.deals.find(d => d.id === proj.dealId);
        if (!deal) return;
        deal.expenses = state.expenses.filter(e => e.projectId === proj.id).reduce((s,e) => s + (e.amount || 0), 0);
      });
      if (state.currentPage === 'expenses') renderExpensesView();
      break;
    }
    case 'team': {
      const data = await api('GET', '/team');
      // Don't re-render if user is actively editing profit share % inputs
      const editing = document.querySelectorAll('input[oninput*="updateMemberPsPct"]');
      const activeEdits = {};
      editing.forEach(el => {
        const match = el.getAttribute('oninput').match(/'([^']+)'/);
        if (match) activeEdits[match[1]] = parseFloat(el.value) || 0;
      });
      state.team = data.map(m => activeEdits[m.id] !== undefined ? { ...m, profitSharePct: activeEdits[m.id] } : m);
      if (state.currentPage === 'team' && Object.keys(activeEdits).length === 0) renderTeamView();
      break;
    }
    case 'payStatus': {
      const data = await api('GET', '/pay-status');
      state.payStatus = data;
      if (state.currentPage === 'pay') renderPayView();
      break;
    }
    case 'psStatus': {
      const data = await api('GET', '/profit-share-status');
      state.profitSharePaidStatus = data;
      if (state.currentPage === 'profitshare') renderProfitShareView();
      break;
    }
  }
  updateBadges();
  // Show a subtle "synced" indicator
  _showSyncPulse();
}

function _showSyncPulse() {
  const el = document.getElementById('sync-indicator');
  if (!el) return;
  el.style.opacity = '1';
  clearTimeout(el._timer);
  el._timer = setTimeout(() => { el.style.opacity = '0'; }, 1500);
}

function updateNavChip() {
  const u = auth.user;
  if (!u) return;
  const m = state.team.find(t => t.id === u.id);
  const col = m ? m.color : AVATAR_COLORS[0];
  const av = document.getElementById('nav-user-avatar');
  if (av) { av.textContent = u.name.split(' ').map(n => n[0]).join(''); av.style.background = col; }
  const nm = document.getElementById('nav-user-name');
  if (nm) nm.textContent = u.name;
  const rl = document.getElementById('nav-user-role');
  const roleLabels = { admin:'Administrator', class_a:'Class A Member', class_b:'Class B Member', va:'Virtual Assistant' };
  if (rl) rl.textContent = roleLabels[u.authRole] || 'Team Member';
  // Show/hide nav items based on role
  const payNav    = document.getElementById('nav-pay');
  const psNav     = document.getElementById('nav-profitshare');
  const teamNav   = document.getElementById('nav-team');
  if (payNav)  payNav.style.display  = can.viewFinance()  ? '' : 'none';
  if (psNav)   psNav.style.display   = can.viewFinance()  ? '' : 'none';
  if (teamNav) teamNav.style.display = can.manageTeam() || auth.role === 'class_a' || auth.role === 'va' ? '' : 'none';
}

function showLogoutConfirm() {
  if (confirm('Sign out of Creative Juice Agency?')) {
    _authToken = null;
    auth = { user: null, role: null };
    state.isAdmin = false;
    if (_realtimeChannel) { _realtimeChannel.unsubscribe(); _realtimeChannel = null; }
    document.getElementById('login-pin').value = '';
    document.getElementById('login-screen').style.display = 'flex';
    initLogin();
  }
}

// Guard: prevent team members from triggering CRM edit modals
function openEditDealModal(id) {
  if (!can.edit()) { notify('You do not have access to edit deals'); return; }
  openDealModal(id);
}

// ============================================================
//  API-CONNECTED STATE MUTATIONS
//  Each function now calls the API and lets realtime sync the UI.
//  On error it reverts local state and shows a notification.
// ============================================================

// ── DEALS ──
async function saveDeal() {
  const name         = document.getElementById('d-name').value.trim();
  const client       = document.getElementById('d-client').value.trim();
  const value        = parseFloat(document.getElementById('d-value').value);
  const stage        = document.getElementById('d-stage').value;
  const owner        = document.getElementById('d-owner').value;
  const closeDate    = document.getElementById('d-closedate').value;
  const expenses     = parseFloat(document.getElementById('d-expenses').value) || 0;
  const invoiceStatus = stage === 'Closed Won' ? document.getElementById('d-invoice').value : 'none';
  const amountCollected = parseFloat(document.getElementById('d-collected').value) || 0;

  if (!name || !client || isNaN(value)) { notify('Please fill in all required fields'); return; }
  const buckets = DEFAULT_BUCKETS.map((b, i) => ({
    ...b,
    pct:        parseFloat(document.getElementById('bpct-' + i)?.value || b.pct),
    assignedTo: b.isPersonal ? (document.getElementById('bassign-' + i)?.value || '') : '',
  }));
  const tot = buckets.reduce((s, b) => s + b.pct, 0);
  if (Math.abs(tot - 100) > 0.2) { notify('Bucket % must total 100%. Current: ' + Math.round(tot * 10) / 10 + '%'); return; }

  const editId    = document.getElementById('deal-modal').dataset.editId;
  const prevStage = editId ? (state.deals.find(d => d.id === editId)?.stage || '') : '';
  const payload   = { name, client, value, expenses, stage, owner, closeDate, invoiceStatus, amountCollected, buckets };

  closeModal('deal-modal');

  try {
    let savedDeal;
    if (editId) {
      savedDeal = await api('PATCH', '/deals/' + editId, payload);
      const idx = state.deals.findIndex(d => d.id === editId);
      if (idx >= 0) state.deals[idx] = savedDeal;
      notify('Deal updated ✓');
    } else {
      savedDeal = await api('POST', '/deals', payload);
      state.deals.push(savedDeal);
      notify('Deal saved ✓');
    }
    renderCRM(); updateBadges();
    // Auto-create project if newly Closed Won
    const isNewlyWon = stage === 'Closed Won' && prevStage !== 'Closed Won';
    const alreadyHasProject = state.projects.some(p => p.dealId === savedDeal.id);
    if (isNewlyWon && !alreadyHasProject) autoCreateProject(savedDeal.id, name, client, closeDate);
  } catch(e) {
    notify('Save failed: ' + e.message);
    renderCRM();
  }
}

// Deal stage drag-drop — optimistic update + API save
async function pipelineDrop(e, stage) {
  e.preventDefault();
  const dealId = e.dataTransfer.getData('text/plain') || _pipelineDragId;
  if (!dealId) return;
  const deal = state.deals.find(d => d.id === dealId);
  if (!deal || deal.stage === stage) return;
  const prevStage = deal.stage;
  deal.stage = stage;  // optimistic
  notify('Moved to ' + stage);
  renderCRM();
  try {
    await api('PATCH', '/deals/' + dealId, { stage });
  } catch(e) {
    deal.stage = prevStage;  // revert on error
    notify('Update failed: ' + e.message);
    renderCRM();
  }
}

async function updateInvStatus(id, status) {
  const d = state.deals.find(d => d.id === id);
  if (!d) return;
  const prev = d.invoiceStatus;
  d.invoiceStatus = status;  // optimistic
  try {
    await api('PATCH', '/deals/' + id, { invoiceStatus: status });
    notify('Invoice status updated ✓');
  } catch(e) {
    d.invoiceStatus = prev;
    notify('Update failed: ' + e.message);
  }
  renderCRM();
}

// ── PROJECTS ──
async function saveProject() {
  const name   = document.getElementById('p-name').value.trim();
  if (!name) { notify('Please enter a project name'); return; }
  const dealId = document.getElementById('p-deal').value;
  const deal   = state.deals.find(d => d.id === dealId);
  const status = document.getElementById('p-status').value || 'active';
  closeModal('project-modal');
  try {
    const proj = await api('POST', '/projects', {
      name, dealId: dealId || null, client: deal?.client || '',
      startDate: document.getElementById('p-start').value,
      endDate:   document.getElementById('p-end').value, status,
    });
    state.projects.push(proj);
    notify('Project created ✓'); renderProjects(); updateBadges();
    document.getElementById('p-name').value = '';
  } catch(e) { notify('Save failed: ' + e.message); }
}

async function autoCreateProject(dealId, dealName, client, closeDate) {
  let startDate = '', endDate = '';
  if (closeDate) {
    startDate = closeDate + '-01';
    const sd = new Date(startDate + 'T12:00:00');
    endDate = new Date(sd.getFullYear(), sd.getMonth() + 2, sd.getDate()).toISOString().split('T')[0];
  }
  try {
    const proj = await api('POST', '/projects', { name: dealName, client, dealId, startDate, endDate, status: 'active' });
    state.projects.push(proj);
    updateBadges();
    showAutoProjectToast(proj, dealName);
  } catch(e) { notify('Could not auto-create project: ' + e.message); }
}

async function setProjectStatusInline(pid, status) {
  const p = state.projects.find(x => x.id === pid);
  if (!p) return;
  const prev = p.status; p.status = status;
  try {
    await api('PATCH', '/projects/' + pid, { status });
    notify(status === 'complete' ? 'Project marked complete ✓' : 'Project marked active');
  } catch(e) {
    p.status = prev;
    notify('Update failed: ' + e.message);
  }
  renderProjMonthly();
  if (state.projectTab === 'grid') renderProjects();
}

// ── TASKS ──
async function saveTask() {
  const title     = document.getElementById('t-title').value.trim();
  const projectId = document.getElementById('t-project').value;
  if (!title || !projectId) { notify('Please enter a title and project'); return; }
  const editId = document.getElementById('task-modal').dataset.editId;
  const payload = {
    title, projectId,
    assigneeId: document.getElementById('t-assignee').value,
    dueDate:    document.getElementById('t-due').value || null,
    priority:   document.getElementById('t-priority').value,
    status:     document.getElementById('t-status').value,
    estHours:   parseFloat(document.getElementById('t-est').value) || 0,
  };
  closeModal('task-modal');
  try {
    if (editId) {
      const updated = await api('PATCH', '/tasks/' + editId, payload);
      const idx = state.tasks.findIndex(t => t.id === editId);
      if (idx >= 0) state.tasks[idx] = updated;
      notify('Task updated ✓');
    } else {
      const created = await api('POST', '/tasks', payload);
      state.tasks.push(created);
      notify('Task added ✓');
    }
    renderTaskView(); updateBadges();
  } catch(e) { notify('Save failed: ' + e.message); }
}

async function deleteTask() {
  const editId = document.getElementById('task-modal').dataset.editId;
  if (!editId || !can.delete()) { notify('Deleting tasks requires Admin or Class A access'); return; }
  const task = state.tasks.find(t => t.id === editId);
  if (!task) return;
  if (!confirm(`Delete "${task.title}"? This cannot be undone.`)) return;
  closeModal('task-modal');
  try {
    await api('DELETE', '/tasks/' + editId);
    state.tasks = state.tasks.filter(t => t.id !== editId);
    renderTaskView(); updateBadges(); notify('Task deleted');
  } catch(e) { notify('Delete failed: ' + e.message); }
}

// Kanban drag — optimistic + API
async function kanbanDrop(e, status) {
  e.preventDefault();
  const taskId = e.dataTransfer.getData('text/plain') || _dragTaskId;
  if (!taskId) return;
  const task = state.tasks.find(t => t.id === taskId);
  if (!task || task.status === status) return;
  const prev = task.status;
  task.status = status;
  notify('Moved to ' + (status==='todo'?'To Do':status==='progress'?'In Progress':status==='review'?'In Review':'Done'));
  renderTaskView(); updateBadges();
  try {
    await api('PATCH', '/tasks/' + taskId, { status });
  } catch(ex) {
    task.status = prev;
    notify('Update failed: ' + ex.message);
    renderTaskView();
  }
}

// Calendar drag — optimistic + API
async function calDrop(e, dateStr) {
  e.preventDefault();
  const taskId = e.dataTransfer.getData('text/plain') || _calDragTaskId;
  if (!taskId) return;
  const task = state.tasks.find(t => t.id === taskId);
  if (!task) return;
  const prev = task.due;
  task.due = dateStr;
  const d = new Date(dateStr + 'T12:00:00');
  notify('Due date → ' + d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
  renderTaskView();
  try {
    await api('PATCH', '/tasks/' + taskId, { dueDate: dateStr });
  } catch(ex) {
    task.due = prev;
    notify('Update failed: ' + ex.message);
    renderTaskView();
  }
}

// ── EXPENSES ──
async function saveExpense() {
  const desc      = document.getElementById('exp-desc').value.trim();
  const amount    = parseFloat(document.getElementById('exp-amount').value);
  const projectId = document.getElementById('exp-project').value;
  const receipt   = document.getElementById('exp-receipt').value.trim();
  if (!desc || isNaN(amount) || !projectId) { notify('Please fill in all required fields'); return; }
  if (!receipt) { notify('Receipt URL is required'); return; }
  const paymentType = document.querySelector('input[name="exp-ptype"]:checked')?.value || 'company';
  const editId = document.getElementById('expense-modal').dataset.editId;
  const payload = {
    description: desc, amount, projectId, receiptUrl: receipt,
    category:    document.getElementById('exp-category').value,
    date:        document.getElementById('exp-date').value,
    submittedBy: document.getElementById('exp-submitted-by').value,
    paymentType,
  };
  closeModal('expense-modal');
  try {
    if (editId) {
      const updated = await api('PATCH', '/expenses/' + editId, payload);
      const idx = state.expenses.findIndex(e => e.id === editId);
      if (idx >= 0) state.expenses[idx] = updated;
      notify('Expense updated ✓');
    } else {
      const created = await api('POST', '/expenses', payload);
      state.expenses.push(created);
      notify('Expense added ✓');
    }
    syncDealExpenses(); renderExpensesView();
  } catch(e) { notify('Save failed: ' + e.message); }
}

async function deleteExpense(id) {
  if (!confirm('Delete this expense?')) return;
  try {
    await api('DELETE', '/expenses/' + id);
    state.expenses = state.expenses.filter(e => e.id !== id);
    syncDealExpenses(); renderExpensesView(); notify('Expense deleted');
  } catch(e) { notify('Delete failed: ' + e.message); }
}

async function toggleReimbursed(id, val) {
  const exp = state.expenses.find(x => x.id === id);
  if (exp) exp.reimbursed = val;
  renderExpensesView();
  try {
    await api('PATCH', '/expenses/' + id, { reimbursed: val });
  } catch(e) {
    if (exp) exp.reimbursed = !val;  // revert
    notify('Update failed: ' + e.message);
    renderExpensesView();
  }
}

// ── PAY STATUS ──
async function togglePayStatus(projId, memberId, checked) {
  const key = projId + '_' + memberId;
  state.payStatus[key] = checked;
  try {
    await api('POST', '/pay-status', { projectId: projId, memberId, paid: checked });
    notify(checked ? 'Marked as paid ✓' : 'Marked as unpaid');
  } catch(e) {
    state.payStatus[key] = !checked;
    notify('Update failed: ' + e.message);
  }
  renderPayView();
}

// ── PROFIT SHARE STATUS ──
async function toggleProfitSharePaid(pkey, checked) {
  state.profitSharePaidStatus[pkey] = checked;
  renderProfitShareView();
  const [quarterKey, memberId] = pkey.split(/_(?=[^_]*$)/);   // split on last underscore
  try {
    await api('POST', '/profit-share-status', { quarterKey, memberId, paid: checked });
    notify(checked ? 'Profit share marked as paid ✓' : 'Marked as unpaid');
  } catch(e) {
    state.profitSharePaidStatus[pkey] = !checked;
    notify('Update failed: ' + e.message);
    renderProfitShareView();
  }
}

// ── TEAM MEMBERS ──
async function saveTeamMember() {
  const name   = document.getElementById('tm-name').value.trim();
  if (!name) { notify('Please enter a name'); return; }
  const ps     = state.isAdmin ? parseFloat(document.getElementById('tm-ps').value) || 0 : 0;
  const editId = document.getElementById('team-modal').dataset.editId;
  const active = document.getElementById('tm-active-no').checked ? false : true;
  const pinEl  = document.getElementById('tm-pin');
  const pin    = pinEl ? pinEl.value.trim() : '';
  const authRole = state.isAdmin ? (document.querySelector('input[name="tm-authrole"]:checked')?.value || 'class_b') : undefined;
  const payload = { name, role: document.getElementById('tm-role').value.trim(), profitSharePct: ps, active };
  if (authRole !== undefined) payload.authRole = authRole;
  if (pin) payload.pin = pin;

  closeModal('team-modal');
  document.getElementById('tm-name').value = '';
  document.getElementById('tm-role').value = '';
  document.getElementById('tm-ps').value   = '0';

  try {
    if (editId) {
      const updated = await api('PATCH', '/team/' + editId, payload);
      const idx = state.team.findIndex(x => x.id === editId);
      if (idx >= 0) state.team[idx] = { ...state.team[idx], ...updated };
      notify('Profile updated ✓');
    } else {
      if (!pin) { notify('PIN is required for new members'); return; }
      const created = await api('POST', '/team', { ...payload, color: AVATAR_COLORS[state.team.length % AVATAR_COLORS.length] });
      state.team.push(created);
      notify('Team member added ✓');
    }
    renderTeamView();
  } catch(e) { notify('Save failed: ' + e.message); }
}

async function deleteTeamMember() {
  const editId = document.getElementById('team-modal').dataset.editId;
  if (!editId || !can.manageTeam()) { notify('Managing team profiles requires Admin access'); return; }
  const m = state.team.find(x => x.id === editId);
  if (!m) return;
  if (!confirm(`Permanently remove ${m.name} from the team? This cannot be undone.`)) return;
  closeModal('team-modal');
  try {
    await api('DELETE', '/team/' + editId);
    state.team = state.team.filter(x => x.id !== editId);
    notify(`${m.name} removed`);
    renderTeamView();
  } catch(e) { notify('Delete failed: ' + e.message); }
}

async function toggleMemberActive(id) {
  const m = state.team.find(x => x.id === id);
  if (!m) return;
  const newActive = m.active === false ? true : false;
  m.active = newActive;
  try {
    await api('PATCH', '/team/' + id, { active: newActive });
    notify(newActive ? `${m.name} reactivated` : `${m.name} set to inactive`);
  } catch(e) {
    m.active = !newActive;
    notify('Update failed: ' + e.message);
  }
  renderTeamView();
}

async function updateMemberPsPct(mid, val) {
  const m = state.team.find(x => x.id === mid);
  if (m) m.profitSharePct = parseFloat(val) || 0;
  // Update the validation badge without full re-render (avoids resetting other inputs)
  const totalPsPct = state.team.filter(x => x.active !== false).reduce((s,x) => s + (x.profitSharePct||0), 0);
  const pctValid = Math.abs(totalPsPct - 100) < 0.5;
  document.querySelectorAll('.ps-total-badge').forEach(el => {
    el.textContent = `Profit share total: ${Math.round(totalPsPct*10)/10}% ${pctValid ? '✓' : '— must total 100%'}`;
    el.style.color = pctValid ? 'var(--text3)' : 'var(--red)';
    el.style.borderColor = pctValid ? 'var(--border)' : 'rgba(224,90,90,0.4)';
  });
  // Debounce API write (wait 800ms after last keystroke)
  clearTimeout(m._psTimer);
  m._psTimer = setTimeout(async () => {
    try { await api('PATCH', '/team/' + mid, { profitSharePct: m.profitSharePct }); }
    catch(e) { notify('Save failed: ' + e.message); }
  }, 800);
}

// ============================================================
//  BOOTSTRAP (no seedData — data lives in Supabase)
// ============================================================
// App starts at login; data loaded after successful auth

// seedData removed — data now lives in Supabase

// ============================================================
//  NAV
// ============================================================
const PAGE_LABELS={crm:'CRM',projects:'Projects',tasks:'Tasks',pay:'Pay Calc',profitshare:'Profit Share',expenses:'Expenses',buckets:'Buckets',team:'Team'};

function switchView(name){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>{if(n.getAttribute('onclick')&&n.getAttribute('onclick').includes("'"+name+"'"))n.classList.add('active');});
  state.currentPage=name;
  // Update mobile page label
  const lbl=document.getElementById('mob-page-label');
  if(lbl) lbl.textContent=PAGE_LABELS[name]||'';
  closeMobileNav();
  renderPage(name);
}

function openMobileNav(){
  document.getElementById('sidebar').classList.add('mob-open');
  document.getElementById('mob-backdrop').classList.add('open');
  document.body.style.overflow='hidden';
}
function closeMobileNav(){
  document.getElementById('sidebar').classList.remove('mob-open');
  document.getElementById('mob-backdrop').classList.remove('open');
  document.body.style.overflow='';
}
function renderPage(name){
  if(name==='crm')renderCRM();
  if(name==='projects'){renderProjects();if(state.projectTab==='monthly')renderProjMonthly();}
  if(name==='tasks'){
    const msel=document.getElementById('task-member-filter');
    if(msel&&msel.options.length<=1) msel.innerHTML='<option value="">All Members</option>'+state.team.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
    renderTaskView();
  }
  if(name==='pay'){renderPayView();}
  if(name==='profitshare'){renderProfitShareView();}
  if(name==='expenses'){renderExpensesView();}
  if(name==='buckets')renderBucketsView();
  if(name==='team')renderTeamView();
  updateBadges();
}
function updateBadges(){
  document.getElementById('crm-badge').textContent=state.deals.length;
  document.getElementById('proj-badge').textContent=state.projects.length;
  document.getElementById('task-badge').textContent=state.tasks.filter(t=>t.status!=='done').length;
}

// ============================================================
//  EXPENSES
// ============================================================
const EXP_CATEGORIES={
  software:'Software',contractor:'Contractor',assets:'Assets',
  advertising:'Advertising',printing:'Printing',travel:'Travel',
  equipment:'Equipment',other:'Other'
};
const EXP_CAT_COLORS={
  software:'#5a8fd4',contractor:'#d47a3a',assets:'#c9a84c',
  advertising:'#9a7fd4',printing:'#4cbfc9',travel:'#4caf7a',
  equipment:'#e05a5a',other:'#5a5a6a'
};

// Recalculate deal.expenses from sum of linked project expenses, then re-render CRM if open
function syncDealExpenses(){
  state.projects.forEach(proj=>{
    const deal=state.deals.find(d=>d.id===proj.dealId);
    if(!deal) return;
    const total=state.expenses
      .filter(e=>e.projectId===proj.id)
      .reduce((s,e)=>s+(e.amount||0),0);
    deal.expenses=Math.round(total*100)/100;
  });
  if(state.currentPage==='crm') renderCRM();
}

function renderExpensesView(){
  const projFilter=document.getElementById('exp-proj-filter')?.value||'';

  // Populate project filter dropdown
  const pfSel=document.getElementById('exp-proj-filter');
  if(pfSel){
    const cur=pfSel.value;
    pfSel.innerHTML='<option value="">All Projects</option>'+
      state.projects.map(p=>`<option value="${p.id}" ${p.id===cur?'selected':''}>${p.name}</option>`).join('');
    pfSel.value=cur;
  }

  const allExp=projFilter?state.expenses.filter(e=>e.projectId===projFilter):state.expenses;
  const totalAll=allExp.reduce((s,e)=>s+(e.amount||0),0);
  const companyTotal=allExp.filter(e=>e.paymentType==='company').reduce((s,e)=>s+(e.amount||0),0);
  const reimbExps=allExp.filter(e=>e.paymentType==='reimbursement');
  const reimbPending=reimbExps.filter(e=>!e.reimbursed).reduce((s,e)=>s+(e.amount||0),0);
  const reimbPaid=reimbExps.filter(e=>e.reimbursed).reduce((s,e)=>s+(e.amount||0),0);

  // ── Reimbursement dashboard ───────────────────────────────
  const reimbByMember={};
  state.team.forEach(m=>{reimbByMember[m.id]={pending:[],paid:[]};});
  reimbExps.forEach(e=>{
    if(!reimbByMember[e.submittedBy]) reimbByMember[e.submittedBy]={pending:[],paid:[]};
    if(e.reimbursed) reimbByMember[e.submittedBy].paid.push(e);
    else             reimbByMember[e.submittedBy].pending.push(e);
  });

  const reimbDashHtml=`<div class="exp-reimb-dashboard">
    <div class="exp-reimb-title"><span class="exp-reimb-title-dot"></span>Reimbursements Due</div>
    <div class="exp-reimb-grid">
      ${state.team.map(m=>{
        const {pending,paid}=reimbByMember[m.id]||{pending:[],paid:[]};
        const pendingTotal=pending.reduce((s,e)=>s+e.amount,0);
        const allClear=pending.length===0;
        return`<div class="exp-reimb-card ${allClear?'all-clear':''}">
          <div class="exp-reimb-member">
            <div class="user-avatar" style="background:${m.color};width:30px;height:30px;font-size:11px">${m.name.split(' ').map(n=>n[0]).join('')}</div>
            <div><div style="font-size:12px;font-weight:500;color:var(--text)">${m.name}</div><div style="font-size:10px;color:var(--text3)">${m.role}</div></div>
          </div>
          <div class="exp-reimb-amount ${allClear?'clear':''}">${allClear?'All clear':fmt(pendingTotal)}</div>
          <div class="exp-reimb-sub">${allClear?`${paid.length} reimbursement${paid.length!==1?'s':''} completed`:`${pending.length} pending · ${paid.length} paid`}</div>
          ${pending.length>0?`<div class="exp-reimb-items">
            ${pending.slice(0,3).map(e=>`<div class="exp-reimb-item-row">
              <span class="exp-reimb-item-desc">${e.description}</span>
              <span class="exp-reimb-item-amt">${fmt(e.amount)}</span>
            </div>`).join('')}
            ${pending.length>3?`<div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);padding-top:4px">+${pending.length-3} more</div>`:''}
          </div>`:''}
        </div>`;
      }).join('')}
    </div>
  </div>`;

  // ── Summary stats ─────────────────────────────────────────
  const byCat={};
  allExp.forEach(e=>{byCat[e.category]=(byCat[e.category]||0)+e.amount;});

  let html=reimbDashHtml+`
    <div class="exp-summary-grid">
      <div class="stat-card"><div class="stat-label">Total Expenses</div><div class="stat-value" style="color:var(--red)">${fmt(totalAll)}</div><div class="stat-delta">${allExp.length} line items</div></div>
      <div class="stat-card"><div class="stat-label">Company Card</div><div class="stat-value" style="color:var(--gold)">${fmt(companyTotal)}</div><div class="stat-delta">${allExp.filter(e=>e.paymentType==='company').length} transactions</div></div>
      <div class="stat-card"><div class="stat-label">Reimbursements Pending</div><div class="stat-value" style="color:var(--red)">${fmt(reimbPending)}</div><div class="stat-delta">${reimbExps.filter(e=>!e.reimbursed).length} outstanding</div></div>
      <div class="stat-card"><div class="stat-label">Reimbursements Paid</div><div class="stat-value" style="color:var(--green)">${fmt(reimbPaid)}</div><div class="stat-delta" style="color:var(--green)">${reimbExps.filter(e=>e.reimbursed).length} completed</div></div>
    </div>
    ${Object.keys(byCat).length>0&&totalAll>0?`<div style="background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px 20px;margin-bottom:24px">
      <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:var(--text3);margin-bottom:12px">Expenses by Category</div>
      <div style="display:flex;height:8px;border-radius:4px;overflow:hidden;margin-bottom:12px">
        ${Object.entries(byCat).sort((a,b)=>b[1]-a[1]).map(([cat,amt])=>`<div style="width:${Math.round(amt/totalAll*100)}%;background:${EXP_CAT_COLORS[cat]||'#555'}" title="${EXP_CATEGORIES[cat]}: ${fmt(amt)}"></div>`).join('')}
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:10px">
        ${Object.entries(byCat).sort((a,b)=>b[1]-a[1]).map(([cat,amt])=>`<div style="display:flex;align-items:center;gap:6px">
          <span style="width:8px;height:8px;border-radius:50%;background:${EXP_CAT_COLORS[cat]||'#555'};flex-shrink:0"></span>
          <span style="font-size:11px;color:var(--text3)">${EXP_CATEGORIES[cat]}</span>
          <span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text2)">${fmt(amt)}</span>
          <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text3)">${Math.round(amt/totalAll*100)}%</span>
        </div>`).join('')}
      </div>
    </div>`:''}
  `;

  // ── Per-project blocks ────────────────────────────────────
  const projectIds=projFilter?[projFilter]:[...new Set(state.expenses.map(e=>e.projectId))];

  projectIds.forEach(pid=>{
    const proj=state.projects.find(p=>p.id===pid);
    if(!proj) return;
    const deal=state.deals.find(d=>d.id===proj.dealId);
    const projExps=state.expenses.filter(e=>e.projectId===pid).sort((a,b)=>new Date(b.date)-new Date(a.date));
    const projTotal=projExps.reduce((s,e)=>s+(e.amount||0),0);
    const compCard=projExps.filter(e=>e.paymentType==='company').reduce((s,e)=>s+(e.amount||0),0);
    const reimbAmt=projExps.filter(e=>e.paymentType==='reimbursement').reduce((s,e)=>s+(e.amount||0),0);
    const reimbPendAmt=projExps.filter(e=>e.paymentType==='reimbursement'&&!e.reimbursed).reduce((s,e)=>s+(e.amount||0),0);
    const netR=deal?netRev(deal):0;
    const expPct=deal&&deal.value>0?Math.round(projTotal/deal.value*100):0;

    html+=`<div class="exp-project-block">
      <div class="exp-project-header">
        <div>
          <div class="exp-project-title">${proj.name}</div>
          <div class="exp-project-meta">${proj.client||deal?.client||''}${deal?` · ${fmt(deal.value)} gross · ${fmt(netR)} net`:''} · ${projExps.length} expense${projExps.length!==1?'s':''}</div>
        </div>
        <div style="display:flex;align-items:center;gap:16px">
          <div style="text-align:right">
            <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);margin-bottom:3px">Expense Total</div>
            <div style="font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:600;color:var(--red);line-height:1">${fmt(projTotal)}</div>
            ${deal?`<div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);margin-top:2px">${expPct}% of gross · <span style="color:var(--green)">net ${fmt(netR)}</span></div>`:''}
          </div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <span class="exp-crm-sync-badge"><svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>Synced to CRM</span>
            <button class="btn btn-sm" onclick="openExpenseModal(null,'${pid}')">+ Add</button>
          </div>
        </div>
      </div>
      ${projExps.length===0
        ?`<div style="padding:28px;text-align:center;color:var(--text3);font-size:12px">No expenses yet — <button class="btn btn-sm" onclick="openExpenseModal(null,'${pid}')">Add first expense</button></div>`
        :`<div class="exp-table-head">
            <span>Description</span>
            <span>Category</span>
            <span>Submitted By</span>
            <span>Date</span>
            <span>Method</span>
            <span>Amount</span>
            <span>Receipt</span>
            <span>Reimbursed</span>
            <span></span>
          </div>
          ${projExps.map(e=>{
            const member=state.team.find(m=>m.id===e.submittedBy);
            const dateStr=e.date?new Date(e.date+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'—';
            const isReimb=e.paymentType==='reimbursement';
            return`<div class="exp-row ${e.reimbursed?'exp-row-reimbursed':''}">
              <div class="exp-desc">${e.description}</div>
              <div><span class="exp-category-pill exp-cat-${e.category}">${EXP_CATEGORIES[e.category]||e.category}</span></div>
              <div>
                ${member?`<div style="display:flex;align-items:center;gap:6px">
                  <div class="deal-avatar" style="background:${member.color};width:20px;height:20px;font-size:8px">${member.name.split(' ').map(n=>n[0]).join('')}</div>
                  <span style="font-size:11px;color:var(--text2)">${member.name.split(' ')[0]}</span>
                </div>`:'<span style="color:var(--text3)">—</span>'}
              </div>
              <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text3)">${dateStr}</div>
              <div><span class="exp-ptype-badge exp-ptype-${e.paymentType}">${isReimb?'Reimb.':'Co. Card'}</span></div>
              <div class="exp-amount-cell">${fmt(e.amount)}</div>
              <div>${e.receipt
                ?`<a class="exp-receipt-link" href="${e.receipt}" target="_blank" rel="noopener"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6M15 3h6v6M10 14L21 3"/></svg>View</a>`
                :`<span class="exp-receipt-missing">Missing</span>`}
              </div>
              <div>
                ${isReimb
                  ?`<label class="exp-reimb-toggle" title="${e.reimbursed?'Mark as pending':'Mark as reimbursed'}">
                      <input type="checkbox" ${e.reimbursed?'checked':''} onchange="toggleReimbursed('${e.id}',this.checked)">
                      <span class="exp-reimb-toggle-label" style="color:${e.reimbursed?'var(--green)':'var(--text3)'}">${e.reimbursed?'Paid':'Pending'}</span>
                    </label>`
                  :`<span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text3)">—</span>`}
              </div>
              <div style="display:flex;gap:4px;align-items:center">
                ${can.manageTeam()?`<button class="exp-delete-btn" onclick="openExpenseModal('${e.id}')" title="Edit expense" style="color:var(--text3)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>`:''}
                ${can.delete()?`<button class="exp-delete-btn" onclick="deleteExpense('${e.id}')" title="Delete expense"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a1 1 0 011-1h6a1 1 0 011 1v2"/></svg></button>`:''}
              </div>
            </div>`;
          }).join('')}
          <div class="exp-breakdown">
            <div class="exp-breakdown-item"><span class="exp-breakdown-dot" style="background:var(--green)"></span>Company Card: <strong style="color:var(--text2)">${fmt(compCard)}</strong></div>
            <div class="exp-breakdown-item"><span class="exp-breakdown-dot" style="background:var(--red)"></span>Reimbursement: <strong style="color:var(--text2)">${fmt(reimbAmt)}</strong>
              ${reimbPendAmt>0?`<span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--red);margin-left:4px">(${fmt(reimbPendAmt)} pending)</span>`:''}
            </div>
            <div class="exp-breakdown-item" style="margin-left:auto;color:var(--text2);font-weight:500">Total: <strong style="color:var(--red);font-size:13px;margin-left:4px">${fmt(projTotal)}</strong></div>
          </div>`}
    </div>`;
  });

  if(projectIds.length===0||state.expenses.length===0){
    html+=`<div class="empty-state"><div class="empty-title">No expenses yet</div><div class="empty-sub">Add your first expense to start tracking project costs.</div></div>`;
  }

  document.getElementById('expenses-content').innerHTML=html;

  const sub=document.getElementById('exp-sub');
  if(sub){
    const proj=projFilter?state.projects.find(p=>p.id===projFilter):null;
    sub.textContent=proj?`${proj.name} · ${fmt(totalAll)} total`:`All projects · ${fmt(totalAll)} total · synced to CRM`;
  }
}

// ============================================================
//  CRM
// ============================================================
function openExpenseModal(editId, preselectedProjectId){
  const e=editId?state.expenses.find(x=>x.id===editId):null;
  document.querySelector('#expense-modal .modal-title').childNodes[0].nodeValue=e?'Edit Expense ':'Add Expense ';
  document.getElementById('exp-project').innerHTML=
    state.projects.filter(p=>p.status!=='complete'&&!p.archived).map(p=>`<option value="${p.id}" ${(e?.projectId||preselectedProjectId)===p.id?'selected':''}>${p.name}</option>`).join('');
  document.getElementById('exp-submitted-by').innerHTML=
    state.team.map(m=>`<option value="${m.id}" ${e?.submittedBy===m.id?'selected':''}>${m.name}</option>`).join('');
  document.getElementById('exp-desc').value=e?e.description:'';
  document.getElementById('exp-amount').value=e?e.amount:'';
  document.getElementById('exp-receipt').value=e?(e.receipt||''):'';
  document.getElementById('exp-category').value=e?e.category:'software';
  document.getElementById('exp-date').value=e?(e.date||''):new Date().toISOString().split('T')[0];
  const pt=e?e.paymentType:'company';
  document.getElementById('ptype-company').checked=pt==='company';
  document.getElementById('ptype-reimb').checked=pt==='reimbursement';
  document.getElementById('expense-modal').dataset.editId=editId||'';
  document.getElementById('expense-modal').classList.add('open');
}



// ============================================================
//  CRM
// ============================================================
function setCrmTab(tab){
  state.crmTab=tab;
  ['pipeline','monthly'].forEach(t=>{
    document.getElementById('tab-'+t).classList.toggle('active',t===tab);
    document.getElementById('tc-'+t).classList.toggle('active',t===tab);
  });
  if(tab==='monthly')renderMonthly();
}

function renderCRM(){
  const total=state.deals.reduce((s,d)=>s+d.value,0);
  const totalNet=state.deals.reduce((s,d)=>s+netRev(d),0);
  const totalExp=state.deals.reduce((s,d)=>s+(d.expenses||0),0);
  const won=state.deals.filter(d=>d.stage==='Closed Won');
  const wonV=won.reduce((s,d)=>s+netRev(d),0);
  const pipe=state.deals.filter(d=>d.stage!=='Closed Won');
  const pipeV=pipe.reduce((s,d)=>s+netRev(d),0);
  const collected=won.filter(d=>d.invoiceStatus==='paid').reduce((s,d)=>s+netRev(d),0);
  const totalCollected=won.reduce((s,d)=>s+(d.amountCollected||0),0);
  const unpaidWon=won.filter(d=>d.invoiceStatus!=='paid');
  const arGross=unpaidWon.reduce((s,d)=>s+netRev(d),0);
  const ar=Math.max(0,arGross-totalCollected);
  const canEdit=can.edit();
  document.getElementById('crm-stats').innerHTML=`
    <div class="stat-card stat-card-gross"><div class="stat-label" style="color:var(--gold)">Gross Revenue</div><div class="stat-value" style="color:var(--gold)">${fmt(total)}</div><div class="stat-delta" style="color:var(--text3)">${totalExp>0?`− ${fmt(totalExp)} expenses`:''} · ${state.deals.length} deals</div></div>
    <div class="stat-card"><div class="stat-label">Net Revenue</div><div class="stat-value">${fmt(totalNet)}</div><div class="stat-delta" style="color:var(--text3)">After expenses</div></div>
    <div class="stat-card"><div class="stat-label">Closed Won (Net)</div><div class="stat-value">${fmt(wonV)}</div><div class="stat-delta">${won.length} deals</div></div>
    <div class="stat-card"><div class="stat-label">Collected (Paid in Full)</div><div class="stat-value" style="color:var(--green)">${fmt(collected)}</div><div class="stat-delta" style="color:var(--text3)">${won.filter(d=>d.invoiceStatus==='paid').length} deals fully paid</div></div>
    <div class="stat-card" style="border-color:rgba(224,90,90,0.25)"><div class="stat-label" style="color:var(--red)">Accounts Receivable</div><div class="stat-value" style="color:var(--red)">${fmt(ar)}</div><div class="stat-delta" style="color:var(--text3)">${fmt(totalCollected)} collected · ${unpaidWon.length} unpaid deals</div></div>
  `;
  // Role-gate topbar
  const taEl=document.getElementById('crm-topbar-actions');
  if(taEl) taEl.innerHTML=canEdit
    ?`<button class="btn btn-primary" onclick="openDealModal()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>New Deal</button>`
    :`<div class="access-denied-inline"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>View only — CRM edits require Admin access</div>`;
  document.getElementById('pipeline-board').innerHTML=STAGES.map((stage,si)=>{
    const deals=state.deals.filter(d=>d.stage===stage);
    return`<div class="pipeline-col"
        data-stage="${stage}"
        ondragover="pipelineDragOver(event,this)"
        ondragleave="pipelineDragLeave(this)"
        ondrop="pipelineDrop(event,'${stage}')">
      <div class="pipeline-header">
        <div class="pipeline-stage"><span class="stage-dot" style="background:${STAGE_COLORS[si]}"></span>${stage}</div>
        <span class="stage-count">${deals.length}</span>
      </div>
      <div class="pipeline-cards">
        ${deals.length===0
          ?`<div style="padding:16px;text-align:center;color:var(--text3);font-size:11px;pointer-events:none">No deals</div>`
          :deals.map(d=>renderDealCard(d)).join('')}
      </div>
    </div>`;
  }).join('');
  if(state.crmTab==='monthly')renderMonthly();
}

function renderDealCard(d){
  const owner=state.team.find(t=>t.id===d.owner);
  const init=owner?owner.name.split(' ').map(n=>n[0]).join(''):'?';
  const col=owner?owner.color:'#555';
  const bars=d.buckets.map(b=>`<div class="bucket-bar" style="width:${b.pct}%;background:${b.color}"></div>`).join('');
  const isWon=d.stage==='Closed Won';
  const nr=netRev(d);
  const hasExp=d.expenses&&d.expenses>0;
  const canEdit=can.edit();
  return`<div class="deal-card${canEdit?'':' no-drag'}"
      ${canEdit?`draggable="true" ondragstart="pipelineDragStart(event,'${d.id}')" ondragend="pipelineDragEnd(event)"`:'' }
      onclick="${canEdit?`openEditDealModal('${d.id}')`:'' }">
    <div class="deal-name">${d.name}</div>
    <div class="deal-client">${d.client}</div>
    <div class="deal-value">${fmt(nr)}<span style="font-size:10px;color:var(--text3);font-family:'DM Sans',sans-serif;font-weight:400;margin-left:4px">net</span></div>
    ${hasExp?`<div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:2px">${fmt(d.value)} gross · ${fmt(d.expenses)} exp</div>`:''}
    <div class="deal-buckets">${bars}</div>
    ${isWon?`<div style="margin-top:8px"><span class="inv-badge ${INV_CLS[d.invoiceStatus||'none']}"><span style="width:5px;height:5px;border-radius:50%;background:currentColor;display:inline-block"></span>${INV_LBL[d.invoiceStatus||'none']}</span></div>`:''}
    <div class="deal-meta"><span class="deal-prob">${d.buckets[0]?.pct||0}% prod</span><div class="deal-avatar" style="background:${col}">${init}</div></div>
  </div>`;
}

// ── Pipeline drag state ──────────────────────────────────────
let _pipelineDragId=null;

function pipelineDragStart(e, dealId){
  _pipelineDragId=dealId;
  e.dataTransfer.effectAllowed='move';
  e.dataTransfer.setData('text/plain', dealId);
  setTimeout(()=>{e.target.classList.add('dragging');},0);
}
function pipelineDragEnd(e){
  e.target.classList.remove('dragging');
  document.querySelectorAll('.pipeline-col').forEach(c=>c.classList.remove('drag-over'));
  _pipelineDragId=null;
}
function pipelineDragOver(e, col){
  e.preventDefault();
  e.dataTransfer.dropEffect='move';
  col.classList.add('drag-over');
}
function pipelineDragLeave(col){
  col.classList.remove('drag-over');
}

// ============================================================
//  MONTHLY VIEW
// ============================================================
function renderMonthly(){
  const now=new Date();
  const vd=new Date(now.getFullYear(),now.getMonth()+state.monthOffset,1);
  const vYM=vd.getFullYear()+'-'+String(vd.getMonth()+1).padStart(2,'0');
  const lbl=MONTHS[vd.getMonth()]+' '+vd.getFullYear();
  const won=state.deals.filter(d=>d.stage==='Closed Won'&&d.closeDate===vYM);
  const totV=won.reduce((s,d)=>s+netRev(d),0);
  const paidV=won.filter(d=>d.invoiceStatus==='paid').reduce((s,d)=>s+netRev(d),0);
  const outV=won.filter(d=>d.invoiceStatus!=='paid').reduce((s,d)=>s+netRev(d),0);
  document.getElementById('monthly-board').innerHTML=`
    <div class="month-nav">
      <button class="month-nav-btn" onclick="changeMonth(-1)">‹</button>
      <div class="month-title">${lbl}</div>
      <button class="month-nav-btn" onclick="changeMonth(1)">›</button>
      <button class="btn btn-sm btn-primary" onclick="openDealModal()" style="margin-left:8px">+ Add Closed Deal</button>
    </div>
    <div class="month-summary">
      <div class="stat-card"><div class="stat-label">Closed This Month</div><div class="stat-value">${fmt(totV)}</div><div class="stat-delta">${won.length} deals</div></div>
      <div class="stat-card"><div class="stat-label">Collected (Paid in Full)</div><div class="stat-value" style="color:var(--green)">${fmt(paidV)}</div><div class="stat-delta" style="color:var(--green)">${won.filter(d=>d.invoiceStatus==='paid').length} deals</div></div>
      <div class="stat-card"><div class="stat-label">Outstanding</div><div class="stat-value" style="color:var(--orange)">${fmt(outV)}</div><div class="stat-delta" style="color:var(--orange)">${won.filter(d=>d.invoiceStatus!=='paid').length} deals</div></div>
    </div>
    ${won.length===0
      ?`<div class="empty-state"><div class="empty-title">No closed deals in ${lbl}</div><div class="empty-sub">Navigate to another month or close a deal from the pipeline.</div></div>`
      :`<div class="monthly-table">
          <div class="mt-head"><span>Deal</span><span>Client</span><span>Value</span><span>Invoice Status</span><span>Owner</span><span>Actions</span></div>
          ${won.map(d=>{
            const own=state.team.find(t=>t.id===d.owner);
            const init=own?own.name.split(' ').map(n=>n[0]).join(''):'?';
            return`<div class="mt-row">
              <div style="font-size:12px;font-weight:500;color:var(--text)">${d.name}</div>
              <div style="font-size:11px;color:var(--text3)">${d.client}</div>
              <div>
                <div style="font-family:'DM Mono',monospace;color:var(--gold)">${fmt(netRev(d))}<span style="font-size:9px;color:var(--text3);margin-left:3px">net</span></div>
                ${d.expenses?`<div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--text3)">${fmt(d.value)} gross</div>`:''}
              </div>
              <div>${can.markPaid()?`<select class="form-select" style="padding:5px 10px;font-size:11px" onchange="updateInvStatus('${d.id}',this.value)">
                <option value="none" ${d.invoiceStatus==='none'?'selected':''}>Not Invoiced</option>
                <option value="sent" ${d.invoiceStatus==='sent'?'selected':''}>Invoice Sent</option>
                <option value="deposit" ${d.invoiceStatus==='deposit'?'selected':''}>Deposit Collected</option>
                <option value="paid" ${d.invoiceStatus==='paid'?'selected':''}>Paid in Full</option>
              </select>`:`<span class="inv-badge ${INV_CLS[d.invoiceStatus||'none']}">${INV_LBL[d.invoiceStatus||'none']}</span>`}</div>
              <div style="display:flex;align-items:center;gap:7px">
                <div class="deal-avatar" style="background:${own?.color||'#555'};width:22px;height:22px;font-size:9px">${init}</div>
                <span style="font-size:11px;color:var(--text2)">${own?.name||'—'}</span>
              </div>
              <div>${can.edit()?`<button class="btn btn-sm" onclick="openEditDealModal('${d.id}')">Edit</button>`:''}</div>
            </div>`;
          }).join('')}
        </div>`}`;
}
function changeMonth(dir){state.monthOffset+=dir;renderMonthly();}
// ============================================================
//  PROJECTS
// ============================================================
function setProjTab(tab){
  state.projectTab=tab;
  ['grid','monthly'].forEach(t=>{
    document.getElementById('ptab-'+t).classList.toggle('active',t===tab);
    document.getElementById('ptc-'+t).classList.toggle('active',t===tab);
  });
  const filterBar=document.getElementById('proj-filter-bar');
  filterBar.style.display=tab==='monthly'?'none':'flex';
  if(tab==='monthly') renderProjMonthly();
  else renderProjects();
}

function setProjFilter(f){
  state.projStatusFilter=f;
  ['active','complete','all','archived'].forEach(x=>{
    const el=document.getElementById('pf-'+x);
    if(el) el.classList.toggle('active',x===f);
  });
  renderProjects();
}

function renderProjects(){
  const grid=document.getElementById('projects-grid');
  if(!state.projects.length){grid.innerHTML=`<div class="empty-state" style="grid-column:1/-1"><div class="empty-title">No projects yet</div></div>`;return;}

  const f=state.projStatusFilter||'active';
  let projs=state.projects.filter(p=>{
    const archived=!!state.archivedProjects[p.id];
    if(f==='archived') return archived;
    if(archived) return false;
    if(f==='active')   return (p.status||'active')==='active';
    if(f==='complete') return p.status==='complete';
    return true; // 'all'
  });

  if(!projs.length){
    grid.innerHTML=`<div class="empty-state" style="grid-column:1/-1"><div class="empty-title">No ${f} projects</div><div class="empty-sub">${f==='archived'?'No archived projects yet.':'Try a different filter.'}</div></div>`;
    return;
  }

  grid.innerHTML=projs.map(p=>{
    const deal=state.deals.find(d=>d.id===p.dealId);
    const tasks=state.tasks.filter(t=>t.projectId===p.id);
    const done=tasks.filter(t=>t.status==='done').length;
    const pct=tasks.length?Math.round(done/tasks.length*100):0;
    const totH=tasks.reduce((s,t)=>s+(t.estHours||0),0);
    const pb=deal?deal.buckets.find(b=>b.name==='Production Pool'):null;
    const pool=deal&&pb?netRev(deal)*pb.pct/100:0;
    const isArchived=!!state.archivedProjects[p.id];
    const pStatus=p.status||'active';
    const isComplete=pStatus==='complete';
    const statusColors={active:'var(--blue)',complete:'var(--green)',archived:'var(--text3)'};
    const sColor=isArchived?'var(--text3)':statusColors[pStatus];
    const progressColor=isComplete?'var(--green)':'linear-gradient(90deg,var(--gold),var(--gold2))';
    return`<div class="project-card" style="${isArchived?'opacity:0.55;':''}" onclick="goToProjectTasks('${p.id}')">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:4px">
        <div class="project-name" style="margin-bottom:0">${p.name}</div>
        <div style="display:flex;align-items:center;gap:6px;flex-shrink:0;margin-left:8px">
          <span class="proj-status ${isArchived?'archived':pStatus}"><span class="proj-status-dot"></span>${isArchived?'Archived':isComplete?'Complete':'Active'}</span>
        </div>
      </div>
      <div class="project-client" style="margin-bottom:14px">${p.client||(deal?deal.client:'—')}${p.end?` · Due ${new Date(p.end+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}`:''}</div>
      <div class="project-progress"><div class="progress-fill" style="width:${pct}%;background:${progressColor}"></div></div>
      <div class="project-stats">
        <div class="project-stat"><strong>${done}/${tasks.length}</strong>Tasks Done</div>
        <div class="project-stat"><strong>${totH}h</strong>Allocated</div>
        <div class="project-stat"><strong style="color:${sColor}">${pct}%</strong>Complete</div>
      </div>
      ${deal?`<div class="project-labor"><span class="labor-label">Production Pool (${pb?.pct||0}% of ${fmt(netRev(deal))} net)</span><span class="labor-value">${fmt(pool)}</span></div>`:''}
      <div style="display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
        <button class="btn btn-sm" onclick="event.stopPropagation();cycleProjectStatus('${p.id}')" style="flex:1;justify-content:center">
          ${isComplete?'↺ Mark Active':'✓ Mark Complete'}
        </button>
        <button class="btn btn-sm" onclick="event.stopPropagation();toggleArchiveProject('${p.id}')" style="color:${isArchived?'var(--green)':'var(--text3)'};border-color:${isArchived?'var(--border2)':'var(--border)'};justify-content:center">
          ${isArchived?'Unarchive':'Archive'}
        </button>
      </div>
    </div>`;
  }).join('');
}

function cycleProjectStatus(pid){
  const p=state.projects.find(x=>x.id===pid);
  if(!p)return;
  p.status=p.status==='complete'?'active':'complete';
  notify(p.status==='complete'?'Project marked complete ✓':'Project marked active');
  renderProjects();
}

function toggleArchiveProject(pid){
  state.archivedProjects[pid]=!state.archivedProjects[pid];
  notify(state.archivedProjects[pid]?'Project archived':'Project unarchived');
  renderProjects();
  renderPayView();
}

function renderProjMonthly(){
  const now=new Date();
  const vd=new Date(now.getFullYear(),now.getMonth()+state.projMonthOffset,1);
  const lbl=MONTHS[vd.getMonth()]+' '+vd.getFullYear();
  const vYM=vd.getFullYear()+'-'+String(vd.getMonth()+1).padStart(2,'0');

  // A project "belongs" to a month if its start month matches.
  // If no start date, fall back to checking if it spans the month.
  const monthly=state.projects.filter(p=>{
    if(!!state.archivedProjects[p.id]) return false;
    const s=p.start?p.start.substring(0,7):'';
    const e=p.end?p.end.substring(0,7):'';
    if(s) return s===vYM; // primary: start month
    if(e) return e===vYM; // fallback: end month
    return false;
  });

  const board=document.getElementById('proj-monthly-board');
  board.innerHTML=`
    <div class="month-nav">
      <button class="month-nav-btn" onclick="changeProjMonth(-1)">‹</button>
      <div class="month-title">${lbl}</div>
      <button class="month-nav-btn" onclick="changeProjMonth(1)">›</button>
      <div style="margin-left:auto;font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);letter-spacing:.08em">Projects started this month</div>
    </div>
    <div class="month-summary" style="margin-bottom:24px">
      <div class="stat-card"><div class="stat-label">Started This Month</div><div class="stat-value">${monthly.length}</div><div class="stat-delta" style="color:var(--blue)">new projects</div></div>
      <div class="stat-card"><div class="stat-label">Active</div><div class="stat-value" style="color:var(--blue)">${monthly.filter(p=>(p.status||'active')==='active').length}</div><div class="stat-delta" style="color:var(--blue)">in progress</div></div>
      <div class="stat-card"><div class="stat-label">Complete</div><div class="stat-value" style="color:var(--green)">${monthly.filter(p=>p.status==='complete').length}</div><div class="stat-delta" style="color:var(--green)">finished</div></div>
    </div>
    ${monthly.length===0
      ?`<div class="empty-state"><div class="empty-title">No projects started in ${lbl}</div><div class="empty-sub">Projects appear here in the month their linked deal closed (or their start date).</div></div>`
      :`<div class="monthly-table">
          <div class="pm-head"><span>Project</span><span>Client</span><span>Status</span><span>Progress</span><span>Hours</span><span>Actions</span></div>
          ${monthly.map(p=>{
            const tasks=state.tasks.filter(t=>t.projectId===p.id);
            const done=tasks.filter(t=>t.status==='done').length;
            const pct=tasks.length?Math.round(done/tasks.length*100):0;
            const totH=tasks.reduce((s,t)=>s+(t.estHours||0),0);
            const deal=state.deals.find(d=>d.id===p.dealId);
            const pStatus=p.status||'active';
            return`<div class="pm-row">
              <div>
                <div style="font-size:12px;font-weight:500;color:var(--text)">${p.name}</div>
                <div style="font-size:10px;color:var(--text3);margin-top:2px">${deal?`Deal: ${deal.name} · ${fmt(deal.value)}`:''}</div>
              </div>
              <div style="font-size:11px;color:var(--text3)">${p.client||'—'}</div>
              <div>
                <select style="background:var(--bg3);border:1px solid var(--border2);border-radius:5px;padding:4px 8px;font-size:10px;font-family:'DM Mono',monospace;color:var(--text2);cursor:pointer" onchange="setProjectStatusInline('${p.id}',this.value)">
                  <option value="active" ${pStatus==='active'?'selected':''}>Active</option>
                  <option value="complete" ${pStatus==='complete'?'selected':''}>Complete</option>
                </select>
              </div>
              <div>
                <div style="display:flex;align-items:center;gap:8px">
                  <div style="flex:1;height:4px;background:var(--bg4);border-radius:2px;overflow:hidden;min-width:60px"><div style="height:100%;width:${pct}%;background:${pStatus==='complete'?'var(--green)':'var(--gold)'};border-radius:2px"></div></div>
                  <span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--text3)">${pct}%</span>
                </div>
              </div>
              <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--gold)">${totH}h</div>
              <div style="display:flex;gap:6px">
                <button class="btn btn-sm" onclick="goToProjectTasks('${p.id}')">Tasks</button>
              </div>
            </div>`;
          }).join('')}
        </div>`}`;
}

function changeProjMonth(dir){state.projMonthOffset+=dir;renderProjMonthly();}


function goToProjectTasks(pid){switchView('tasks');document.getElementById('task-project-filter').value=pid;renderTaskView();}

// ============================================================
//  TASKS
// ============================================================
function setTaskView(mode){
  state.taskView=mode;
  ['kanban','list','calendar'].forEach(v=>{
    document.getElementById('task-'+v).className='task-'+v+'-view'+(v===mode?' active':'');
    document.getElementById('btn-'+v).className='view-btn'+(v===mode?' active':'');
  });
  renderTaskView();
}
function renderTaskView(){
  const projFilter=document.getElementById('task-project-filter')?.value;
  const memberFilter=document.getElementById('task-member-filter')?.value;
  let tasks=state.tasks;
  if(projFilter) tasks=tasks.filter(t=>t.projectId===projFilter);
  if(memberFilter) tasks=tasks.filter(t=>t.assigneeId===memberFilter);

  // Update subtitle
  const proj=projFilter?state.projects.find(p=>p.id===projFilter):null;
  const member=memberFilter?state.team.find(m=>m.id===memberFilter):null;
  const subParts=[];
  if(proj) subParts.push(proj.name); else subParts.push('All projects');
  if(member) subParts.push(member.name); else subParts.push('All members');
  const subEl=document.getElementById('tasks-sub');
  if(subEl) subEl.textContent=subParts.join(' · ');

  if(state.taskView==='kanban')renderKanban(tasks);
  if(state.taskView==='list')renderList(tasks);
  if(state.taskView==='calendar')renderCalendar(tasks);

  // Refresh project filter
  const sel=document.getElementById('task-project-filter');
  if(sel){const cur=sel.value;sel.innerHTML='<option value="">All Projects</option>'+state.projects.map(p=>`<option value="${p.id}" ${p.id===cur?'selected':''}>${p.name}</option>`).join('');}
  // Refresh member filter
  const msel=document.getElementById('task-member-filter');
  if(msel){const cur=msel.value;msel.innerHTML='<option value="">All Members</option>'+state.team.map(m=>`<option value="${m.id}" ${m.id===cur?'selected':''}>${m.name}</option>`).join('');msel.value=cur;}
}
// Calculate the production pool pay for a single task
function calcTaskPay(task){
  const proj=state.projects.find(p=>p.id===task.projectId);
  if(!proj) return 0;
  const deal=state.deals.find(d=>d.id===proj.dealId);
  if(!deal) return 0;
  const pb=deal.buckets.find(b=>b.name==='Production Pool');
  if(!pb) return 0;
  const pool=netRev(deal)*pb.pct/100;
  const totalHours=state.tasks.filter(t=>t.projectId===task.projectId).reduce((s,t)=>s+(t.estHours||0),0);
  if(!totalHours||!task.estHours) return 0;
  return pool*(task.estHours/totalHours);
}

// ── Kanban drag state ──────────────────────────────────────
let _dragTaskId=null;

function renderKanban(tasks){
  const st=[{key:'todo',label:'To Do',color:'var(--text3)'},{key:'progress',label:'In Progress',color:'var(--blue)'},{key:'review',label:'In Review',color:'var(--purple)'},{key:'done',label:'Done',color:'var(--green)'}];
  document.getElementById('task-kanban').innerHTML=`<div class="kanban">${st.map(s=>{
    const cols=tasks.filter(t=>t.status===s.key);
    return`<div class="kanban-col"
        data-status="${s.key}"
        ondragover="kanbanDragOver(event,this)"
        ondragleave="kanbanDragLeave(this)"
        ondrop="kanbanDrop(event,'${s.key}')">
      <div class="kanban-header">
        <div class="kanban-stage"><span class="stage-dot" style="background:${s.color}"></span><span style="color:${s.color}">${s.label}</span></div>
        <span class="stage-count">${cols.length}</span>
      </div>
      <div class="kanban-cards">
        ${cols.length===0
          ?`<div style="padding:12px;text-align:center;color:var(--text3);font-size:11px;pointer-events:none">Empty</div>`
          :cols.map(t=>renderTaskCard(t)).join('')}
      </div>
    </div>`;
  }).join('')}</div>`;
}

function renderTaskCard(t){
  const a=state.team.find(m=>m.id===t.assigneeId);
  const init=a?a.name.split(' ').map(n=>n[0]).join(''):'?';
  const ac=a?a.color:'#555';
  const proj=state.projects.find(p=>p.id===t.projectId);
  const ds=t.due?formatDue(t.due):null;
  const dc=ds?getDueClass(t.due):'';
  const h=t.estHours||0;
  const pay=calcTaskPay(t);
  return`<div class="task-card"
      draggable="true"
      data-task-id="${t.id}"
      ondragstart="kanbanDragStart(event,'${t.id}')"
      ondragend="kanbanDragEnd(event)"
      onclick="openEditTaskModal('${t.id}')">
    <div class="task-title">${t.title}</div>
    <div class="task-meta">
      <span class="task-tag priority-${t.priority}">${t.priority}</span>
      ${proj?`<span style="font-size:10px;color:var(--text3)">${proj.name.length>14?proj.name.substring(0,13)+'…':proj.name}</span>`:''}
      ${ds?`<span class="task-due ${dc}"><svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>${ds}</span>`:''}
      <span class="task-hours"><svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>${h}h</span>
      <div class="deal-avatar" style="background:${ac};width:18px;height:18px;font-size:8px">${init}</div>
    </div>
    ${pay>0?`<div style="display:flex;align-items:center;justify-content:space-between;margin-top:9px;padding-top:8px;border-top:1px solid var(--border)">
      <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.08em;text-transform:uppercase;color:var(--text3)">Task Pay</span>
      <span style="font-family:'DM Mono',monospace;font-size:12px;color:var(--green);font-weight:500">${fmt(pay)}</span>
    </div>`:''}
    ${h>0?`<div class="hours-bar" style="margin-top:${pay>0?'6px':'8px'}"><div class="hours-fill" style="width:100%"></div></div>`:''}
  </div>`;
}

function kanbanDragStart(e, taskId){
  _dragTaskId=taskId;
  e.dataTransfer.effectAllowed='move';
  e.dataTransfer.setData('text/plain', taskId);
  // slight delay so the drag image captures before class is applied
  setTimeout(()=>{e.target.classList.add('dragging');},0);
}
function kanbanDragEnd(e){
  e.target.classList.remove('dragging');
  document.querySelectorAll('.kanban-col').forEach(c=>c.classList.remove('drag-over'));
  _dragTaskId=null;
}
function kanbanDragOver(e, col){
  e.preventDefault();
  e.dataTransfer.dropEffect='move';
  col.classList.add('drag-over');
}
function kanbanDragLeave(col){
  col.classList.remove('drag-over');
}

function renderList(tasks){
  document.getElementById('task-list').innerHTML=`<div style="background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden">
    <table class="list-table"><thead><tr><th>Task</th><th>Project</th><th>Assigned To</th><th>Due</th><th>Priority</th><th>Status</th><th>Hours</th><th>Task Pay</th></tr></thead>
    <tbody>${tasks.length===0?`<tr><td colspan="8" style="text-align:center;color:var(--text3);padding:32px">No tasks</td></tr>`:tasks.map(t=>{
      const proj=state.projects.find(p=>p.id===t.projectId);
      const a=state.team.find(m=>m.id===t.assigneeId);
      const dc=t.due?getDueClass(t.due):'';
      const pay=calcTaskPay(t);
      return`<tr style="cursor:pointer" onclick="openEditTaskModal('${t.id}')"><td style="color:var(--text);font-weight:500">${t.title}</td><td style="color:var(--text3)">${proj?.name||'—'}</td>
        <td><div style="display:flex;align-items:center;gap:7px"><div class="deal-avatar" style="background:${a?.color||'#555'};width:22px;height:22px;font-size:9px">${a?a.name.split(' ').map(n=>n[0]).join(''):'?'}</div><span style="color:var(--text2)">${a?.name||'—'}</span></div></td>
        <td class="${'task-due '+dc}">${t.due?formatDue(t.due):'—'}</td>
        <td><span class="task-tag priority-${t.priority}">${t.priority}</span></td>
        <td><span class="task-tag status-${t.status}">${statusLabel(t.status)}</span></td>
        <td style="font-family:'DM Mono',monospace;color:var(--gold)">${t.estHours||0}h</td>
        <td style="font-family:'DM Mono',monospace;color:${pay>0?'var(--green)':'var(--text3)'}">${pay>0?fmt(pay):'—'}</td>
      </tr>`;
    }).join('')}</tbody></table></div>`;
}
function renderCalendar(tasks){
  const now=new Date();
  const yr=now.getFullYear(),mo=now.getMonth();
  const fd=new Date(yr,mo,1).getDay(),dim=new Date(yr,mo+1,0).getDate();
  const tbd={};
  tasks.forEach(t=>{if(t.due){if(!tbd[t.due])tbd[t.due]=[];tbd[t.due].push(t);}});
  const dn=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let cells='';
  for(let i=0;i<fd;i++) cells+=`<div class="cal-day other-month"><div class="cal-day-num">${new Date(yr,mo,0).getDate()-fd+i+1}</div></div>`;
  const ts=now.toISOString().split('T')[0];
  for(let d=1;d<=dim;d++){
    const ds=`${yr}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dt=tbd[ds]||[];
    cells+=`<div class="cal-day${ds===ts?' today':''}"
        data-date="${ds}"
        ondragover="calDragOver(event,this)"
        ondragleave="calDragLeave(this)"
        ondrop="calDrop(event,'${ds}')">
      <div class="cal-day-num">${d}</div>
      ${dt.slice(0,3).map(t=>{
        const a=state.team.find(m=>m.id===t.assigneeId);
        return`<div class="cal-task"
            style="background:${a?.color||'#888'}"
            draggable="true"
            data-task-id="${t.id}"
            ondragstart="calDragStart(event,'${t.id}')"
            ondragend="calDragEnd(event)"
            onclick="event.stopPropagation();openEditTaskModal('${t.id}')"
            title="${t.title}">${t.title}</div>`;
      }).join('')}
      ${dt.length>3?`<div style="font-size:9px;color:var(--text3);cursor:pointer" onclick="event.stopPropagation()" title="${dt.slice(3).map(t=>t.title).join(', ')}">+${dt.length-3} more</div>`:''}
    </div>`;
  }
  const rem=(fd+dim)%7===0?0:7-(fd+dim)%7;
  for(let i=1;i<=rem;i++) cells+=`<div class="cal-day other-month"><div class="cal-day-num">${i}</div></div>`;
  document.getElementById('task-calendar').innerHTML=`<div style="margin-bottom:16px"><span style="font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:600;color:var(--text)">${MONTHS[mo]} ${yr}</span></div><div class="calendar-grid">${dn.map(d=>`<div class="cal-header">${d}</div>`).join('')}${cells}</div>`;
}

let _calDragTaskId=null;
function calDragStart(e, taskId){
  _calDragTaskId=taskId;
  e.dataTransfer.effectAllowed='move';
  e.dataTransfer.setData('text/plain', taskId);
  setTimeout(()=>{e.target.style.opacity='0.4';},0);
}
function calDragEnd(e){
  e.target.style.opacity='';
  document.querySelectorAll('.cal-day').forEach(d=>d.classList.remove('drag-over'));
  _calDragTaskId=null;
}
function calDragOver(e, cell){
  if(cell.classList.contains('other-month')) return;
  e.preventDefault();
  e.dataTransfer.dropEffect='move';
  cell.classList.add('drag-over');
}
function calDragLeave(cell){ cell.classList.remove('drag-over'); }

// ============================================================
//  PAY CALCULATOR
// ============================================================
function setPayFilter(f){
  state.payStatusFilter=f;
  ['all','complete','active','archived'].forEach(x=>{
    const el=document.getElementById('payf-'+x);
    if(el) el.classList.toggle('active',x===f);
  });
  renderPayView();
}

function renderPayView(){
  const sel=document.getElementById('pay-project-filter');
  const fv=sel?sel.value:'';
  sel.innerHTML='<option value="">All Projects</option>'+state.projects.map(p=>`<option value="${p.id}" ${p.id===fv?'selected':''}>${p.name}</option>`).join('');

  const sf=state.payStatusFilter||'all';
  let projects=state.projects.filter(p=>{
    const archived=!!state.archivedProjects[p.id];
    if(sf==='archived') return archived;
    if(archived) return false;
    if(sf==='complete') return p.status==='complete';
    if(sf==='active')   return (p.status||'active')==='active';
    return !archived;
  });
  if(fv) projects=projects.filter(p=>p.id===fv);

  let html='';

  projects.forEach(proj=>{
    const deal=state.deals.find(d=>d.id===proj.dealId);
    if(!deal)return;
    const pb=deal.buckets.find(b=>b.name==='Production Pool');
    const pool=pb?netRev(deal)*pb.pct/100:0;
    const tasks=state.tasks.filter(t=>t.projectId===proj.id);
    const totH=tasks.reduce((s,t)=>s+(t.estHours||0),0);
    const uh={};
    tasks.forEach(t=>{if(!uh[t.assigneeId])uh[t.assigneeId]={hours:0,tasks:[]};uh[t.assigneeId].hours+=(t.estHours||0);uh[t.assigneeId].tasks.push(t);});
    const specials=deal.buckets.filter(b=>b.isPersonal&&b.assignedTo);

    const pStatus=proj.status||'active';
    const isArchived=!!state.archivedProjects[proj.id];
    const nr=netRev(deal);
    html+=`<div class="pay-section">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:6px;gap:12px">
        <div class="section-title" style="margin-bottom:0">${proj.name}<span class="section-sub">Production pool ${fmt(pool)} · ${totH}h · ${fmt(nr)} net revenue${deal.expenses?` (${fmt(deal.value)} gross − ${fmt(deal.expenses)} exp)`:''}</span></div>
        <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;padding-top:4px">
          <span class="proj-status ${isArchived?'archived':pStatus}"><span class="proj-status-dot"></span>${isArchived?'Archived':pStatus==='complete'?'Complete':'Active'}</span>
          <button class="btn btn-sm" onclick="toggleArchiveProject('${proj.id}')" style="color:${isArchived?'var(--green)':'var(--text3)'}">${isArchived?'Unarchive':'Archive'}</button>
        </div>
      </div>`;

    if(totH>0){
      html+=`<div class="pay-sub-header" style="margin-top:0;border-top:none;padding-top:0">Production Pool — distributed by hours share</div>
      <div class="pay-grid" style="margin-bottom:8px">
        ${state.team.map(m=>{
          const data=uh[m.id];
          const hours=data?data.hours:0;
          const pkey=proj.id+'_'+m.id;
          const paid=!!state.payStatus[pkey];
          if(!hours)return`<div class="pay-card" style="opacity:0.35"><div class="pay-user"><div class="user-avatar" style="background:${m.color}">${m.name.split(' ').map(n=>n[0]).join('')}</div><div><div class="user-name">${m.name}</div><div class="user-role">${m.role}</div></div></div><div class="pay-total" style="color:var(--text3)">$0</div><div style="font-size:11px;color:var(--text3)">No tasks assigned</div></div>`;
          const share=hours/totH;
          const payout=pool*share;
          const pct=Math.round(share*100);
          return`<div class="pay-card" style="${paid?'border-color:rgba(76,175,122,0.35)':''}">
            <div class="pay-user"><div class="user-avatar" style="background:${m.color}">${m.name.split(' ').map(n=>n[0]).join('')}</div><div><div class="user-name">${m.name}</div><div class="user-role">${m.role}</div></div></div>
            <div class="pay-total">${fmt(payout)}</div>
            <div class="pay-bar"><div class="pay-bar-fill" style="width:${pct}%;background:${m.color}"></div></div>
            <div class="pay-breakdown">
              <div class="pay-row"><span class="pay-row-label">Hours allocated</span><span class="pay-row-value">${hours}h</span></div>
              <div class="pay-row"><span class="pay-row-label">Share of project hours</span><span class="pay-row-value">${pct}% (${hours}h / ${totH}h)</span></div>
              <div class="pay-row"><span class="pay-row-label">Payout from pool</span><span class="pay-row-value">${fmt(payout)} of ${fmt(pool)}</span></div>
              <div class="pay-row"><span class="pay-row-label">Tasks</span><span class="pay-row-value">${data.tasks.length}</span></div>
            </div>
            <div class="paid-status">
              <label class="paid-toggle" style="${!can.markPaid()?'opacity:0.4;pointer-events:none':''}"><input type="checkbox" ${paid?'checked':''} ${!can.markPaid()?'disabled':''} onchange="togglePaid('${proj.id}','${m.id}',this.checked)"><span class="toggle-slider"></span></label>
              <span class="paid-label ${paid?'yes':'no'}">${paid?'PAID':'UNPAID'}</span>
            </div>
          </div>`;
        }).join('')}
      </div>`;
    }

    if(specials.length){
      html+=`<div class="pay-sub-header">Special Fees — fixed assignments</div>
      <div class="pay-grid">
        ${specials.map(b=>{
          const m=state.team.find(x=>x.id===b.assignedTo);
          if(!m)return'';
          const amt=netRev(deal)*b.pct/100;
          const pkey=proj.id+'_fee_'+b.name.replace(/\s/g,'_')+'_'+m.id;
          const paid=!!state.payStatus[pkey];
          return`<div class="pay-card" style="${paid?'border-color:rgba(76,175,122,0.35)':''}">
            <div class="pay-user"><div class="user-avatar" style="background:${m.color}">${m.name.split(' ').map(n=>n[0]).join('')}</div><div><div class="user-name">${m.name}</div><div class="user-role">${m.role}</div></div></div>
            <div class="pay-total" style="color:var(--teal)">${fmt(amt)}</div>
            <div class="pay-breakdown" style="margin-top:8px">
              <div class="pay-row"><span class="pay-row-label">Fee type</span><span class="pay-row-value" style="color:var(--teal)">${b.name}</span></div>
              <div class="pay-row"><span class="pay-row-label">Rate</span><span class="pay-row-value">${b.pct}% of ${fmt(netRev(deal))} net</span></div>
            </div>
            <div class="paid-status">
              <label class="paid-toggle" style="${!can.markPaid()?'opacity:0.4;pointer-events:none':''}"><input type="checkbox" ${paid?'checked':''} ${!can.markPaid()?'disabled':''} onchange="togglePaid('${proj.id}_fee_${b.name.replace(/\s/g,'_')}','${m.id}',this.checked)"><span class="toggle-slider"></span></label>
              <span class="paid-label ${paid?'yes':'no'}">${paid?'PAID':'UNPAID'}</span>
            </div>
          </div>`;
        }).join('')}
      </div>`;
    }

    if(!totH&&!specials.length)html+=`<div style="color:var(--text3);font-size:12px;padding:12px 0">No tasks or fee assignments yet.</div>`;
    html+='</div>';
  });

  if(!html)html=`<div class="empty-state"><div class="empty-title">No projects with linked deals</div><div class="empty-sub">Link a deal to a project to see pay calculations</div></div>`;
  document.getElementById('pay-content').innerHTML=html;
}

function togglePaid(projId,memberId,checked){
  state.payStatus[projId+'_'+memberId]=checked;
  notify(checked?'Marked as paid ✓':'Marked as unpaid');
  renderPayView();
}

// ============================================================
//  BUCKETS VIEW
// ============================================================
function renderBucketsView(){
  let html='';
  state.deals.forEach(deal=>{
    html+=`<div class="bucket-table" style="margin-bottom:20px">
      <div class="bucket-table-header">
        <div><div style="font-size:13px;font-weight:500;color:var(--text)">${deal.name}</div><div class="bucket-table-title" style="margin-top:4px">${deal.client} · ${fmt(netRev(deal))} net · ${deal.expenses?`${fmt(deal.value)} gross · `:''} ${deal.stage}</div></div>
        <span class="inv-badge ${INV_CLS[deal.invoiceStatus||'none']}">${INV_LBL[deal.invoiceStatus||'none']}</span>
      </div>
      <div>
        <div class="bucket-row" style="background:var(--bg);border-bottom:1px solid var(--border)">
          <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">Bucket</span>
          <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">%</span>
          <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">Visual</span>
          <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3);text-align:right">$ Amount</span>
          <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">Assigned To</span>
        </div>
        ${deal.buckets.map(b=>{
          const a=b.assignedTo?state.team.find(m=>m.id===b.assignedTo):null;
          return`<div class="bucket-row">
            <div class="bucket-name-cell"><span class="bucket-icon" style="background:${b.color}"></span>${b.name}${b.isPersonal?` <span class="bucket-special">fee</span>`:''}</div>
            <div class="bucket-pct">${b.pct}%</div>
            <div class="bucket-mini-bar"><div class="bucket-fill" style="width:${b.pct}%;background:${b.color}"></div></div>
            <div class="bucket-amount">${fmt(netRev(deal)*b.pct/100)}</div>
            <div class="bucket-assignee">${a?`<div class="deal-avatar" style="background:${a.color};width:20px;height:20px;font-size:9px">${a.name.split(' ').map(n=>n[0]).join('')}</div><span>${a.name}</span>`:`<span style="color:var(--text3)">—</span>`}</div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  });
  if(!html)html=`<div class="empty-state"><div class="empty-title">No deals yet</div></div>`;
  document.getElementById('buckets-content').innerHTML=html;
}

// ============================================================
//  TEAM VIEW
// ============================================================
function setTeamTab(tab){
  state.teamTab=tab;
  ['overview','monthly','manage'].forEach(t=>{
    const el=document.getElementById('ttab-'+t);
    if(el) el.classList.toggle('active',t===tab);
  });
  renderTeamView();
}

function renderTeamView(){
  // Topbar actions
  const ta=document.getElementById('team-topbar-actions');
  if(ta) ta.innerHTML=auth.role==='admin'
    ?`<button class="btn btn-primary" onclick="openTeamModal()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>Add Member</button>`
    :'';

  // Hide manage tab for non-admins
  const manageTab=document.getElementById('ttab-manage');
  if(manageTab) manageTab.style.display=auth.role==='admin'?'':'none';
  if(state.teamTab==='manage'&&!can.manageTeam()) state.teamTab='overview';

  if(state.teamTab==='overview') renderTeamOverview();
  else if(state.teamTab==='monthly') renderTeamMonthly();
  else if(state.teamTab==='manage') renderTeamManage();
}

// ── Shared earnings calculator ────────────────────────────────
// ============================================================
//  EARNINGS CALCULATIONS
//  Actual   = deal paid in full + project complete + all tasks done
//  Projected = deal Closed Won (not yet paid in full)
//  filterFn(deal) = optional month scope for monthly view
// ============================================================

function calcActualEarnings(filterFn){
  const prodPay={},feePay={},psPay={};
  state.team.forEach(m=>{prodPay[m.id]=0;feePay[m.id]=0;psPay[m.id]=0;});

  state.projects.forEach(proj=>{
    const deal=state.deals.find(d=>d.id===proj.dealId);
    if(!deal) return;
    if(deal.stage!=='Closed Won'||deal.invoiceStatus!=='paid') return;
    if(proj.status!=='complete') return;
    if(filterFn&&!filterFn(deal)) return;
    // All tasks on this project must be done
    const tasks=state.tasks.filter(t=>t.projectId===proj.id);
    if(tasks.length>0&&tasks.some(t=>t.status!=='done')) return;
    // Production pool
    const pb=deal.buckets.find(b=>b.name==='Production Pool');
    if(pb){
      const pool=netRev(deal)*pb.pct/100;
      const tH=tasks.reduce((s,t)=>s+(t.estHours||0),0);
      if(tH){const uh={};tasks.forEach(t=>{uh[t.assigneeId]=(uh[t.assigneeId]||0)+(t.estHours||0);});Object.entries(uh).forEach(([mid,h])=>{if(prodPay[mid]!==undefined)prodPay[mid]+=pool*(h/tH);});}
    }
    // Personal fees
    deal.buckets.filter(b=>b.isPersonal&&b.assignedTo).forEach(b=>{if(feePay[b.assignedTo]!==undefined)feePay[b.assignedTo]+=netRev(deal)*b.pct/100;});
  });

  // Actual profit share — paid + complete project + all tasks done
  const eligibleDeals=state.deals.filter(d=>{
    if(d.stage!=='Closed Won'||d.invoiceStatus!=='paid') return false;
    const proj=state.projects.find(p=>p.dealId===d.id);
    if(!proj||proj.status!=='complete') return false;
    const tasks=state.tasks.filter(t=>t.projectId===proj.id);
    if(tasks.length>0&&tasks.some(t=>t.status!=='done')) return false;
    return filterFn?filterFn(d):true;
  });
  const totalPsPool=eligibleDeals.reduce((s,d)=>{const psB=d.buckets.find(b=>b.name==='Profit Share');return s+netRev(d)*(psB?psB.pct:17.5)/100;},0);
  state.team.forEach(m=>{psPay[m.id]=totalPsPool*(m.profitSharePct||0)/100;});

  return{prodPay,feePay,psPay,eligibleDeals};
}

function calcProjectedEarnings(filterFn){
  const prodPay={},feePay={},psPay={};
  state.team.forEach(m=>{prodPay[m.id]=0;feePay[m.id]=0;psPay[m.id]=0;});

  // Only Closed Won deals NOT yet paid in full
  state.projects.forEach(proj=>{
    const deal=state.deals.find(d=>d.id===proj.dealId);
    if(!deal) return;
    if(deal.stage!=='Closed Won'||deal.invoiceStatus==='paid') return;
    if(proj.archived) return;
    if(filterFn&&!filterFn(deal)) return;
    const pb=deal.buckets.find(b=>b.name==='Production Pool');
    if(pb){
      const pool=netRev(deal)*pb.pct/100;
      const tasks=state.tasks.filter(t=>t.projectId===proj.id);
      const tH=tasks.reduce((s,t)=>s+(t.estHours||0),0);
      if(tH){const uh={};tasks.forEach(t=>{uh[t.assigneeId]=(uh[t.assigneeId]||0)+(t.estHours||0);});Object.entries(uh).forEach(([mid,h])=>{if(prodPay[mid]!==undefined)prodPay[mid]+=pool*(h/tH);});}
    }
    deal.buckets.filter(b=>b.isPersonal&&b.assignedTo).forEach(b=>{if(feePay[b.assignedTo]!==undefined)feePay[b.assignedTo]+=netRev(deal)*b.pct/100;});
  });

  // Projected profit share — Closed Won not yet paid
  const projectedDeals=state.deals.filter(d=>{
    if(d.stage!=='Closed Won'||d.invoiceStatus==='paid') return false;
    return filterFn?filterFn(d):true;
  });
  const totalPsPool=projectedDeals.reduce((s,d)=>{const psB=d.buckets.find(b=>b.name==='Profit Share');return s+netRev(d)*(psB?psB.pct:17.5)/100;},0);
  state.team.forEach(m=>{psPay[m.id]=totalPsPool*(m.profitSharePct||0)/100;});

  return{prodPay,feePay,psPay,projectedDeals};
}

// Legacy wrapper used by pay calculator and profit share views
function calcTeamEarnings(filterFn){
  const actual=calcActualEarnings(filterFn);
  const totH={};
  state.team.forEach(m=>{totH[m.id]=0;});
  state.tasks.forEach(t=>{if(totH[t.assigneeId]!==undefined)totH[t.assigneeId]+=(t.estHours||0);});
  return{totH,prodPay:actual.prodPay,feePay:actual.feePay,psPay:actual.psPay,eligibleDeals:actual.eligibleDeals};
}

function renderTeamOverview(){
  const{totH}=calcTeamEarnings(null);
  const{prodPay,feePay,psPay,eligibleDeals}=calcActualEarnings(null);
  const{prodPay:projProd,feePay:projFee,psPay:projPs,projectedDeals}=calcProjectedEarnings(null);
  const totalPsPct=state.team.filter(m=>m.active!==false).reduce((s,m)=>s+(m.profitSharePct||0),0);
  const pctValid=Math.abs(totalPsPct-100)<0.5;

  document.getElementById('team-content').innerHTML=`
    ${can.adminFinance()?`<div class="admin-banner"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Admin Mode — edit profit share % inline, or use Manage Profiles tab for full control</div>`:''}
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
    ${state.team.map(m=>{
      const inactive=m.active===false;
      const total=(prodPay[m.id]||0)+(feePay[m.id]||0)+(psPay[m.id]||0);
      return`<div class="pay-card${inactive?' inactive-card':''}">
        <div class="pay-user">
          <div class="user-avatar" style="background:${m.color};${inactive?'filter:grayscale(0.7)':''}">${m.name.split(' ').map(n=>n[0]).join('')}</div>
          <div style="flex:1;min-width:0"><div class="user-name">${m.name}</div><div class="user-role">${m.role}</div></div>
          <span class="member-status-badge ${inactive?'status-inactive':'status-active'}">${inactive?'Inactive':'Active'}</span>
        </div>
        ${inactive?`<div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);text-align:center;padding:12px 0">Member is inactive</div>`:`
        ${can.adminFinance()
          ?`<div style="background:var(--bg3);border:1px solid var(--gold-dim2);border-radius:6px;padding:8px 12px;margin-bottom:12px">
              <div style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.12em;text-transform:uppercase;color:var(--gold);margin-bottom:6px;display:flex;align-items:center;gap:6px"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Profit Share %</div>
              <div style="display:flex;align-items:center;gap:8px">
                <input type="number" value="${m.profitSharePct||0}" min="0" max="100" step="0.5" style="width:70px;background:var(--bg4);border:1px solid var(--gold-dim2);border-radius:4px;padding:5px 8px;color:var(--gold);font-family:'DM Mono',monospace;font-size:13px;text-align:right;outline:none" oninput="updateMemberPsPct('${m.id}',this.value)">
                <span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text3)">% of pool</span>
              </div>
            </div>`
          :`<div class="pay-row" style="margin-bottom:4px"><span class="pay-row-label">Profit share allocation</span><span class="pay-row-value" style="color:var(--green)">${m.profitSharePct||0}%</span></div>`
        }
        <div style="display:flex;flex-direction:column;gap:6px">
          <div class="pay-row"><span class="pay-row-label">Hours allocated</span><span class="pay-row-value">${totH[m.id]||0}h</span></div>
          <div style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);padding:6px 0 2px;border-top:1px solid var(--border);margin-top:2px">Actual Earnings</div>
          <div class="pay-row"><span class="pay-row-label">Production</span><span class="pay-row-value" style="color:var(--gold)">${fmt(prodPay[m.id]||0)}</span></div>
          <div class="pay-row"><span class="pay-row-label">Fees</span><span class="pay-row-value" style="color:var(--teal)">${fmt(feePay[m.id]||0)}</span></div>
          <div class="pay-row"><span class="pay-row-label">Profit share</span><span class="pay-row-value" style="color:var(--green)">${fmt(psPay[m.id]||0)}</span></div>
          <div style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.1em;text-transform:uppercase;color:var(--blue);padding:6px 0 2px;border-top:1px solid var(--border);margin-top:2px">Projected Earnings</div>
          <div class="pay-row"><span class="pay-row-label">Production</span><span class="pay-row-value" style="color:var(--blue)">${fmt(projProd[m.id]||0)}</span></div>
          <div class="pay-row"><span class="pay-row-label">Fees</span><span class="pay-row-value" style="color:var(--blue)">${fmt(projFee[m.id]||0)}</span></div>
          <div class="pay-row"><span class="pay-row-label">Profit share</span><span class="pay-row-value" style="color:var(--blue)">${fmt(projPs[m.id]||0)}</span></div>
          <div class="pay-row" style="border-top:1px solid var(--border);padding-top:10px;margin-top:4px">
            <span class="pay-row-label" style="color:var(--text2);font-weight:600;font-size:12px">Total (actual + projected)</span>
            <span class="pay-row-value" style="color:var(--gold);font-size:14px;font-weight:600">${fmt(total+(projProd[m.id]||0)+(projFee[m.id]||0)+(projPs[m.id]||0))}</span>
          </div>
          <div class="pay-row"><span class="pay-row-label">Active tasks</span><span class="pay-row-value">${state.tasks.filter(t=>t.assigneeId===m.id&&t.status!=='done').length}</span></div>
        </div>`}
      </div>`;
    }).join('')}
    </div>
    ${can.adminFinance()?`<div class="ps-total-badge" style="margin-top:16px;padding:10px 16px;background:var(--bg2);border:1px solid ${pctValid?'var(--border)':'rgba(224,90,90,0.4)'};border-radius:8px;font-family:'DM Mono',monospace;font-size:11px;color:${pctValid?'var(--text3)':'var(--red)'}">Active member profit share total: <strong>${Math.round(totalPsPct*10)/10}%</strong>${pctValid?' ✓':' — must total 100%'}</div>`:''}`;
}

function renderTeamMonthly(){
  const now=new Date();
  const vd=new Date(now.getFullYear(),now.getMonth()+state.teamMonthOffset,1);
  const vYM=vd.getFullYear()+'-'+String(vd.getMonth()+1).padStart(2,'0');
  const lbl=MONTHS[vd.getMonth()]+' '+vd.getFullYear();

  // Scope both sides to the selected close month
  const monthFilter=d=>d.closeDate===vYM;
  const{prodPay:actProd,feePay:actFee,psPay:actPs,eligibleDeals}=calcActualEarnings(monthFilter);
  const{prodPay:prjProd,feePay:prjFee,psPay:prjPs}=calcProjectedEarnings(monthFilter);

  const activeMembers=state.team.filter(m=>m.active!==false);

  // Grand totals for the total column (actual + projected, no double-counting)
  const grandActual=activeMembers.reduce((s,m)=>s+(actProd[m.id]||0)+(actFee[m.id]||0)+(actPs[m.id]||0),0);
  const grandProj=activeMembers.reduce((s,m)=>s+(prjProd[m.id]||0)+(prjFee[m.id]||0)+(prjPs[m.id]||0),0);
  const grandTotal=grandActual+grandProj;

  // Sparkline uses actual+projected combined per month
  const sparkMonths=[];
  for(let i=5;i>=0;i--){
    const sd=new Date(now.getFullYear(),now.getMonth()-i,1);
    const sym=sd.getFullYear()+'-'+String(sd.getMonth()+1).padStart(2,'0');
    const mf=d=>d.closeDate===sym;
    const{prodPay:sa,feePay:fa,psPay:pa}=calcActualEarnings(mf);
    const{prodPay:sp,feePay:fp,psPay:pp}=calcProjectedEarnings(mf);
    const tot=state.team.reduce((s,m)=>s+(sa[m.id]||0)+(fa[m.id]||0)+(pa[m.id]||0)+(sp[m.id]||0)+(fp[m.id]||0)+(pp[m.id]||0),0);
    sparkMonths.push({label:MONTHS[sd.getMonth()].substring(0,3),ym:sym,total:tot});
  }
  const sparkMax=Math.max(...sparkMonths.map(x=>x.total),1);

  // Column layout: Member | Act.Prod | Act.Fees | Act.PS | separator | Prj.Prod | Prj.Fees | Prj.PS | Total
  const colW=`1fr 90px 80px 90px 4px 90px 80px 90px 4px 100px 100px 110px`;

  document.getElementById('team-content').innerHTML=`
    <div class="team-month-nav">
      <button class="month-nav-btn" onclick="changeTeamMonth(-1)">‹</button>
      <span class="team-month-label">${lbl}</span>
      <button class="month-nav-btn" onclick="changeTeamMonth(1)">›</button>
      <div style="margin-left:auto;font-family:'DM Mono',monospace;font-size:11px;color:var(--text3)">
        Actual: <strong style="color:var(--gold)">${fmt(grandActual)}</strong>
        <span style="margin:0 8px;color:var(--border2)">|</span>
        Projected: <strong style="color:var(--blue)">${fmt(grandProj)}</strong>
        <span style="margin:0 8px;color:var(--border2)">|</span>
        Total: <strong style="color:var(--text)">${fmt(grandTotal)}</strong>
      </div>
    </div>

    <!-- 6-month sparkline -->
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px 20px;margin-bottom:24px">
      <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:var(--text3);margin-bottom:12px">6-Month Earnings History (Actual + Projected)</div>
      <div style="display:flex;align-items:flex-end;gap:6px;height:52px;margin-bottom:8px">
        ${sparkMonths.map(s=>`<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px">
          <div style="width:100%;background:${s.ym===vYM?'var(--gold)':'var(--bg4)'};border-radius:3px 3px 0 0;height:${Math.round((s.total/sparkMax)*44)+4}px;min-height:4px;transition:height .3s" title="${fmt(s.total)}"></div>
        </div>`).join('')}
      </div>
      <div style="display:flex;gap:6px">
        ${sparkMonths.map(s=>`<div style="flex:1;text-align:center;font-family:'DM Mono',monospace;font-size:8px;color:${s.ym===vYM?'var(--gold)':'var(--text3)'};">${s.label}</div>`).join('')}
      </div>
    </div>

    <div class="team-monthly-table" style="overflow-x:auto">
      <!-- Section headers -->
      <div style="display:grid;grid-template-columns:${colW};padding:6px 16px 0">
        <span></span>
        <span colspan="3" style="grid-column:span 3;font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.14em;text-transform:uppercase;color:var(--gold);padding-bottom:4px;border-bottom:2px solid var(--gold);text-align:center">— ACTUAL —</span>
        <span></span>
        <span colspan="3" style="grid-column:span 3;font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.14em;text-transform:uppercase;color:var(--blue);padding-bottom:4px;border-bottom:2px solid var(--blue);text-align:center">— PROJECTED —</span>
        <span></span>
        <span style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.14em;text-transform:uppercase;color:var(--gold);text-align:center">Act. Total</span>
        <span style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.14em;text-transform:uppercase;color:var(--blue);text-align:center">Proj. Total</span>
        <span style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.14em;text-transform:uppercase;color:var(--text3);text-align:center">Combined</span>
      </div>
      <!-- Column headers -->
      <div class="team-monthly-head" style="grid-template-columns:${colW}">
        <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.1em;text-transform:uppercase;color:var(--text3)">Member</span>
        <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--gold)">Prod.</span>
        <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--teal)">Fees</span>
        <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--green)">Profit Shr.</span>
        <span></span>
        <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue)">Prod.</span>
        <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue)">Fees</span>
        <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue)">Profit Shr.</span>
        <span></span>
        <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--gold)">Total</span>
        <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue)">Total</span>
        <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.1em;text-transform:uppercase;color:var(--text3)">Combined</span>
      </div>
      <!-- Member rows -->
      ${activeMembers.map(m=>{
        const aP=actProd[m.id]||0, aF=actFee[m.id]||0, aPs=actPs[m.id]||0;
        const pP=prjProd[m.id]||0, pF=prjFee[m.id]||0, pPs=prjPs[m.id]||0;
        const total=aP+aF+aPs+pP+pF+pPs;
        const pct=grandTotal>0?Math.round(total/grandTotal*100):0;
        const cell=(v,color)=>`<div style="font-family:'DM Mono',monospace;font-size:12px;color:${v>0?color:'var(--text3)'}">${v>0?fmt(v):'—'}</div>`;
        return`<div class="team-monthly-row" style="grid-template-columns:${colW}">
          <div style="display:flex;align-items:center;gap:10px">
            <div class="user-avatar" style="background:${m.color};width:28px;height:28px;font-size:10px">${m.name.split(' ').map(n=>n[0]).join('')}</div>
            <div><div style="font-size:12px;font-weight:500;color:var(--text)">${m.name}</div><div style="font-size:10px;color:var(--text3)">${m.role}</div></div>
          </div>
          ${cell(aP,'var(--gold)')}
          ${cell(aF,'var(--teal)')}
          ${cell(aPs,'var(--green)')}
          <div style="border-left:1px solid var(--border2);margin:4px 0"></div>
          ${cell(pP,'var(--blue)')}
          ${cell(pF,'var(--blue)')}
          ${cell(pPs,'var(--blue)')}
          <div style="border-left:1px solid var(--border2);margin:4px 0"></div>
          <div style="font-family:'DM Mono',monospace;font-size:12px;font-weight:600;color:${(aP+aF+aPs)>0?'var(--gold)':'var(--text3)'}">${(aP+aF+aPs)>0?fmt(aP+aF+aPs):'—'}</div>
          <div style="font-family:'DM Mono',monospace;font-size:12px;font-weight:600;color:${(pP+pF+pPs)>0?'var(--blue)':'var(--text3)'}">${(pP+pF+pPs)>0?fmt(pP+pF+pPs):'—'}</div>
          <div>
            <div style="font-family:'DM Mono',monospace;font-size:13px;font-weight:600;color:${total>0?'var(--text)':'var(--text3)'}">${total>0?fmt(total):'$0'}</div>
            ${grandTotal>0&&total>0?`<div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text3)">${pct}% of total</div>`:''}
          </div>
        </div>`;
      }).join('')}
      <!-- Total row -->
      <div class="team-monthly-row" style="grid-template-columns:${colW};background:var(--bg);border-top:2px solid var(--border2)">
        <div style="font-size:12px;font-weight:600;color:var(--text2);font-family:'DM Mono',monospace;letter-spacing:.04em">TOTAL</div>
        <div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--gold);font-weight:600">${fmt(activeMembers.reduce((s,m)=>s+(actProd[m.id]||0),0))}</div>
        <div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--teal);font-weight:600">${fmt(activeMembers.reduce((s,m)=>s+(actFee[m.id]||0),0))}</div>
        <div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--green);font-weight:600">${fmt(activeMembers.reduce((s,m)=>s+(actPs[m.id]||0),0))}</div>
        <div style="border-left:1px solid var(--border2);margin:4px 0"></div>
        <div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--blue);font-weight:600">${fmt(activeMembers.reduce((s,m)=>s+(prjProd[m.id]||0),0))}</div>
        <div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--blue);font-weight:600">${fmt(activeMembers.reduce((s,m)=>s+(prjFee[m.id]||0),0))}</div>
        <div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--blue);font-weight:600">${fmt(activeMembers.reduce((s,m)=>s+(prjPs[m.id]||0),0))}</div>
        <div style="border-left:1px solid var(--border2);margin:4px 0"></div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:600;color:var(--gold)">${fmt(grandActual)}</div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:600;color:var(--blue)">${fmt(grandProj)}</div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:600;color:var(--text)">${fmt(grandTotal)}</div>
      </div>
    </div>
    ${eligibleDeals.length===0&&grandProj===0?`<div style="margin-top:12px;font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);text-align:center">No qualifying deals with close month set to ${lbl}</div>`:''}
  `;
}
function changeTeamMonth(delta){
  state.teamMonthOffset+=delta;
  renderTeamMonthly();
}

function renderTeamManage(){
  if(!can.manageTeam()){document.getElementById('team-content').innerHTML=`<div class="empty-state"><div class="empty-title">Admin access required</div></div>`;return;}
  const totalPsPct=state.team.filter(m=>m.active!==false).reduce((s,m)=>s+(m.profitSharePct||0),0);
  const pctValid=Math.abs(totalPsPct-100)<0.5;

  document.getElementById('team-content').innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:600;color:var(--text)">${state.team.length} Team Members</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">${state.team.filter(m=>m.active!==false).length} active · ${state.team.filter(m=>m.active===false).length} inactive</div>
      </div>
      <div style="padding:8px 14px;background:var(--bg2);border:1px solid ${pctValid?'var(--border)':'rgba(224,90,90,0.4)'};border-radius:8px;font-family:'DM Mono',monospace;font-size:11px;color:${pctValid?'var(--text3)':'var(--red)'}">
        Profit share total: <strong>${Math.round(totalPsPct*10)/10}%</strong> ${pctValid?'✓':'— must total 100%'}
      </div>
    </div>
    <div class="manage-grid">
      ${state.team.map(m=>{
        const inactive=m.active===false;
        const taskCount=state.tasks.filter(t=>t.assigneeId===m.id&&t.status!=='done').length;
        return`<div class="manage-card${inactive?' inactive-card':''}">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
            <div class="user-avatar" style="background:${m.color};width:36px;height:36px;font-size:13px;${inactive?'filter:grayscale(0.6)':''}">${m.name.split(' ').map(n=>n[0]).join('')}</div>
            <div style="flex:1;min-width:0">
              <div style="font-size:13px;font-weight:600;color:var(--text)">${m.name}</div>
              <div style="font-size:11px;color:var(--text3)">${m.role}</div>
            </div>
            <span class="member-status-badge ${inactive?'status-inactive':'status-active'}">${inactive?'Inactive':'Active'}</span>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;font-size:11px">
            <div style="display:flex;justify-content:space-between">
              <span style="color:var(--text3)">Profit Share</span>
              <span style="font-family:'DM Mono',monospace;color:var(--green)">${m.profitSharePct||0}%</span>
            </div>
            <div style="display:flex;justify-content:space-between">
              <span style="color:var(--text3)">Open Tasks</span>
              <span style="font-family:'DM Mono',monospace;color:var(--text2)">${taskCount}</span>
            </div>
          </div>
          <div class="manage-card-actions">
            <button class="btn btn-sm" style="flex:1" onclick="openTeamModal('${m.id}')">Edit Profile</button>
            <button class="btn btn-sm" style="flex:1;color:${inactive?'var(--green)':'var(--red)'};border-color:${inactive?'rgba(76,175,122,0.35)':'rgba(224,90,90,0.35)'}" onclick="toggleMemberActive('${m.id}')">${inactive?'Activate':'Deactivate'}</button>
          </div>
        </div>`;
      }).join('')}
    </div>
  `;
}


function openTeamModal(editId){
  const m=editId?state.team.find(x=>x.id===editId):null;
  const titleNode=document.querySelector('#team-modal .modal-title').childNodes[0];
  titleNode.nodeValue=m?'Edit Member ':'Add Team Member ';
  document.getElementById('tm-name').value=m?m.name:'';
  document.getElementById('tm-role').value=m?m.role:'';
  document.getElementById('tm-ps').value=m?(m.profitSharePct||0):0;
  document.getElementById('tm-ps-group').style.display=can.manageTeam()?'block':'none';
  // PIN field
  const pinEl=document.getElementById('tm-pin');
  const pinHint=document.getElementById('tm-pin-hint');
  if(pinEl) pinEl.value='';
  if(pinHint) pinHint.textContent=m?'Leave blank to keep current PIN':'Required for new members';
  // Active toggle — only show when editing
  const activeGroup=document.getElementById('tm-active-group');
  activeGroup.style.display=m&&can.manageTeam()?'block':'none';
  if(m){
    document.getElementById('tm-active-yes').checked=m.active!==false;
    document.getElementById('tm-active-no').checked=m.active===false;
  }
  // Auth role — show for admin, default to current value
  const authRoleGroup=document.getElementById('tm-authrole-group');
  authRoleGroup.style.display=can.manageTeam()?'block':'none';
  const currentRole=m?m.authRole:'class_b';
  ['admin','class_a','class_b','va'].forEach(r=>{
    const el=document.getElementById('tm-authrole-'+r);
    if(el) el.checked=(currentRole===r);
  });
  // Delete button — only when editing
  const delWrap=document.getElementById('tm-delete-wrap');
  delWrap.style.display=m&&can.manageTeam()?'block':'none';
  const saveBtn=document.getElementById('tm-save-btn');
  if(saveBtn) saveBtn.textContent=m?'Save Changes':'Add Member';
  document.getElementById('team-modal').dataset.editId=editId||'';
  document.getElementById('team-modal').classList.add('open');
}



// ============================================================
//  ADMIN & PROFIT SHARE
// ============================================================
function toggleAdmin(on){
  if(on&&auth.role!=='admin'){
    const el=document.getElementById('admin-toggle');
    if(el) el.checked=false;
    notify('Admin mode requires Administrator account');
    return;
  }
  state.isAdmin=on;
  const lbl=document.getElementById('admin-label');
  if(lbl){lbl.textContent=on?'ON':'OFF';lbl.style.color=on?'var(--gold)':'var(--text3)';}
  renderProfitShareView();
  if(state.currentPage==='team') renderTeamView();
}


function getQuarterLabel(dateStr){
  // dateStr = YYYY-MM-DD or YYYY-MM
  if(!dateStr) return null;
  const parts=dateStr.split('-');
  const y=parseInt(parts[0]);
  const m=parseInt(parts[1]);
  const q=Math.ceil(m/3);
  return {key:`${y}-Q${q}`,label:`Q${q} ${y}`,year:y,quarter:q};
}

function renderProfitShareView(){
  // Render topbar based on role
  const ptEl=document.getElementById('profitshare-topbar-actions');
  if(ptEl) ptEl.innerHTML=auth.role==='admin'
    ?`<div style="display:flex;align-items:center;gap:10px;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:6px 14px">
        <span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);letter-spacing:.08em">ADMIN MODE</span>
        <label class="paid-toggle"><input type="checkbox" id="admin-toggle" ${state.isAdmin?'checked':''} onchange="toggleAdmin(this.checked)"><span class="toggle-slider"></span></label>
        <span id="admin-label" style="font-family:'DM Mono',monospace;font-size:10px;color:${state.isAdmin?'var(--gold)':'var(--text3)'};letter-spacing:.08em">${state.isAdmin?'ON':'OFF'}</span>
      </div>`
    :`<div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);display:flex;align-items:center;gap:6px"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>View only</div>`;
  // Collect all deals that are: Closed Won + invoiceStatus=paid + linked project is complete
  const eligibleDeals=state.deals.filter(d=>{
    if(d.stage!=='Closed Won') return false;
    if(d.invoiceStatus!=='paid') return false;
    // Check if linked project is complete
    const proj=state.projects.find(p=>p.dealId===d.id);
    return proj&&proj.status==='complete';
  });

  // Build quarter buckets using deal closeDate
  const quarterMap={};
  eligibleDeals.forEach(d=>{
    const q=getQuarterLabel(d.closeDate||'');
    if(!q) return;
    if(!quarterMap[q.key]) quarterMap[q.key]={...q,deals:[],totalDealValue:0,profitSharePool:0};
    const psB=d.buckets.find(b=>b.name==='Profit Share');
    const psPct=psB?psB.pct:17.5;
    const psAmt=netRev(d)*psPct/100;
    quarterMap[q.key].deals.push({...d,psAmt,psPct});
    quarterMap[q.key].totalDealValue+=d.value;
    quarterMap[q.key].profitSharePool+=psAmt;
  });

  const quarters=Object.values(quarterMap).sort((a,b)=>b.year-a.year||b.quarter-a.quarter);
  const totalPs=quarters.reduce((s,q)=>s+q.profitSharePool,0);
  const totalPaid=Object.entries(state.profitSharePaidStatus).filter(([,v])=>v).length;
  const totalMembers=state.team.length;
  const totalSlots=quarters.length*totalMembers;
  const pctPaid=totalSlots?Math.round(totalPaid/totalSlots*100):0;

  const totalPsPct=state.team.reduce((s,m)=>s+(m.profitSharePct||0),0);
  const pctBalanced=Math.abs(totalPsPct-100)<0.5;

  let html=``;

  // Admin banner
  if(state.isAdmin){
    html+=`<div class="admin-banner" style="margin-bottom:20px"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> Admin Mode — Edit profit share percentages directly on each member card below</div>`;
  }

  if(!pctBalanced){
    html+=`<div style="background:rgba(224,90,90,0.08);border:1px solid rgba(224,90,90,0.3);border-radius:8px;padding:10px 16px;margin-bottom:20px;font-size:12px;color:var(--red);display:flex;align-items:center;gap:8px">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
      Profit share percentages total <strong>${Math.round(totalPsPct*10)/10}%</strong> — must total 100% for accurate distribution. ${state.isAdmin?'Edit percentages in Team Members or on the cards below.':'Contact an admin to adjust.'}
    </div>`;
  }

  // Summary stats
  html+=`<div class="ps-summary-grid">
    <div class="stat-card"><div class="stat-label">Total Profit Share Pool</div><div class="stat-value" style="color:var(--green)">${fmt(totalPs)}</div><div class="stat-delta">${eligibleDeals.length} qualifying deals</div></div>
    <div class="stat-card"><div class="stat-label">Active Quarters</div><div class="stat-value">${quarters.length}</div><div class="stat-delta" style="color:var(--blue)">${quarters.map(q=>q.label).join(', ')||'—'}</div></div>
    <div class="stat-card"><div class="stat-label">Team Members</div><div class="stat-value">${totalMembers}</div><div class="stat-delta" style="color:var(--text3)">sharing ${pctBalanced?'100':'?'}% of pool</div></div>
    <div class="stat-card"><div class="stat-label">Payouts Completed</div><div class="stat-value" style="color:${pctPaid===100?'var(--green)':'var(--text)'}">${pctPaid}%</div><div class="stat-delta" style="color:var(--text3)">${totalPaid} of ${totalSlots} marked paid</div></div>
  </div>`;

  if(!quarters.length){
    html+=`<div class="empty-state"><div class="empty-title">No qualifying deals yet</div><div class="empty-sub">Profit share is calculated from deals that are Closed Won, Paid in Full, and have a Completed project.</div></div>`;
  }

  quarters.forEach(q=>{
    const paidCount=state.team.filter(m=>!!state.profitSharePaidStatus[`${q.key}_${m.id}`]).length;
    html+=`<div>
      <div class="ps-quarter-header">
        <div class="ps-quarter-label">${q.label}<span class="ps-quarter-sub">${q.deals.length} deal${q.deals.length!==1?'s':''} · ${fmt(q.totalDealValue)} total value</span></div>
        <div style="display:flex;align-items:center;gap:10px">
          <span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--text3)">${paidCount}/${totalMembers} paid</span>
          <span class="ps-pool-badge">${fmt(q.profitSharePool)} pool</span>
        </div>
      </div>
      <!-- Deal source mini-list -->
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;margin-bottom:14px;overflow:hidden">
        <div style="padding:8px 16px;background:var(--bg);border-bottom:1px solid var(--border);display:grid;grid-template-columns:1fr 100px 80px 120px;gap:12px">
          <span style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">Deal</span>
          <span style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">Value</span>
          <span style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">PS %</span>
          <span style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">PS Amount</span>
        </div>
        ${q.deals.map(d=>`<div style="padding:10px 16px;border-bottom:1px solid var(--border);display:grid;grid-template-columns:1fr 100px 80px 120px;gap:12px;align-items:center">
          <div>
            <div style="font-size:12px;font-weight:500;color:var(--text)">${d.name}</div>
            <div style="font-size:10px;color:var(--text3)">${d.client}</div>
          </div>
          <div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--gold)">${fmt(d.value)}</div>
          <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text3)">${d.psPct}%</div>
          <div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--green)">${fmt(d.psAmt)}</div>
        </div>`).join('')}
      </div>
      <!-- Member allocation cards -->
      <div class="ps-member-grid">
        ${state.team.map(m=>{
          const pkey=`${q.key}_${m.id}`;
          const paid=!!state.profitSharePaidStatus[pkey];
          const psPct=m.profitSharePct||0;
          const allocation=q.profitSharePool*psPct/100;
          return`<div class="ps-card ${paid?'paid-card':''}">
            <div class="ps-card-top">
              <div class="user-avatar" style="background:${m.color};width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#0e0e0f;flex-shrink:0">${m.name.split(' ').map(n=>n[0]).join('')}</div>
              <div style="flex:1;min-width:0">
                <div class="ps-name">${m.name}</div>
                <div class="ps-role">${m.role}</div>
              </div>
              <div class="ps-pct-badge">${psPct}%</div>
            </div>
            ${state.isAdmin?`
              <div class="ps-edit-pct">
                <span class="ps-edit-label"><svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display:inline-block;vertical-align:middle;margin-right:4px"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Share %</span>
                <input class="ps-edit-input" type="number" value="${psPct}" min="0" max="100" step="0.5" oninput="updateMemberPsPct('${m.id}',this.value)">
              </div>`:''}
            <div class="ps-amount">${fmt(allocation)}</div>
            <div class="ps-bar"><div class="ps-bar-fill" style="width:${psPct}%"></div></div>
            <div class="ps-breakdown">
              <div class="ps-row"><span class="ps-row-label">Share of pool</span><span class="ps-row-val">${psPct}% × ${fmt(q.profitSharePool)}</span></div>
              <div class="ps-row"><span class="ps-row-label">Quarter</span><span class="ps-row-val">${q.label}</span></div>
            </div>
            <div class="paid-status">
              <label class="paid-toggle" style="${!can.markPaid()?'opacity:0.4;pointer-events:none':''}"><input type="checkbox" ${paid?'checked':''} ${!can.markPaid()?'disabled':''} onchange="toggleProfitSharePaid('${pkey}',this.checked)"><span class="toggle-slider"></span></label>
              <span class="paid-label ${paid?'yes':'no'}">${paid?'PAID':'UNPAID'}</span>
              ${paid?`<span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);margin-left:auto">✓ Disbursed</span>`:''}
            </div>
          </div>`;
        }).join('')}
      </div>
      <div class="ps-divider"></div>
    </div>`;
  });

  document.getElementById('profitshare-content').innerHTML=html;
}


function openDealModal(editId){
  const d=editId?state.deals.find(x=>x.id===editId):null;
  document.querySelector('#deal-modal .modal-title').childNodes[0].nodeValue=d?'Edit Deal ':'New Deal ';
  document.getElementById('d-owner').innerHTML=state.team.map(m=>`<option value="${m.id}" ${d&&d.owner===m.id?'selected':''}>${m.name}</option>`).join('');
  document.getElementById('d-name').value=d?d.name:'';
  document.getElementById('d-client').value=d?d.client:'';
  document.getElementById('d-value').value=d?d.value:'';
  document.getElementById('d-expenses').value=d?(d.expenses||0):'';
  document.getElementById('d-closedate').value=d?(d.closeDate||''):'';
  document.getElementById('d-stage').value=d?d.stage:'Lead';
  document.getElementById('d-invoice').value=d?(d.invoiceStatus||'none'):'none';
  document.getElementById('d-collected').value=d?(d.amountCollected||0):0;
  toggleInvoiceStatus();
  updateNetRevPreview();
  document.getElementById('deal-modal').dataset.editId=editId||'';
  const buckets=d?d.buckets:DEFAULT_BUCKETS.map(b=>({...b,assignedTo:''}));
  document.getElementById('deal-bucket-inputs').innerHTML=buckets.map((b,i)=>`
    <div class="bucket-input-row">
      <span style="background:${b.color};width:10px;height:10px;border-radius:2px;display:inline-block;flex-shrink:0"></span>
      <span style="font-size:12px;color:var(--text2)">${b.name}${b.isPersonal?` <span class="bucket-special">fee</span>`:''}</span>
      <input class="form-input" style="padding:6px 10px;text-align:right;font-size:12px" type="number" id="bpct-${i}" value="${b.pct}" min="0" max="100" step="0.5" oninput="updatePctTotal()">
      ${b.isPersonal
        ?`<select class="form-select" style="padding:6px 10px;font-size:12px" id="bassign-${i}"><option value="">— Assign to —</option>${state.team.map(m=>`<option value="${m.id}" ${b.assignedTo===m.id?'selected':''}>${m.name}</option>`).join('')}</select>`
        :`<span></span>`}
    </div>`).join('');
  updatePctTotal();
  document.getElementById('deal-modal').classList.add('open');
}
function toggleInvoiceStatus(){
  document.getElementById('d-invoice-group').style.display=document.getElementById('d-stage').value==='Closed Won'?'block':'none';
}
function updatePctTotal(){
  let t=0;DEFAULT_BUCKETS.forEach((_,i)=>{const v=parseFloat(document.getElementById('bpct-'+i)?.value||0);t+=v;});
  const el=document.getElementById('pct-total');
  el.textContent=`Total: ${Math.round(t*10)/10}%`;
  el.className='pct-total '+(Math.abs(t-100)<0.15?'valid':'invalid');
}


function showAutoProjectToast(proj,dealName){
  // Create a richer notification with a "View Project" action
  const existing=document.getElementById('auto-proj-toast');
  if(existing)existing.remove();
  const toast=document.createElement('div');
  toast.id='auto-proj-toast';
  toast.style.cssText=`position:fixed;bottom:24px;right:24px;background:var(--bg2);border:1px solid var(--gold-dim2);border-radius:10px;padding:16px 18px;z-index:2001;max-width:320px;animation:fadeInUp 0.25s ease;box-shadow:0 8px 32px rgba(0,0,0,0.4)`;
  toast.innerHTML=`
    <div style="display:flex;align-items:flex-start;gap:12px">
      <div style="width:32px;height:32px;border-radius:50%;background:var(--green-dim);display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2M9 12l2 2 4-4"/></svg>
      </div>
      <div style="flex:1;min-width:0">
        <div style="font-size:12px;font-weight:500;color:var(--text);margin-bottom:3px">Project Auto-Created</div>
        <div style="font-size:11px;color:var(--text3);margin-bottom:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">"${dealName}" is now in Projects</div>
        <div style="display:flex;gap:8px">
          <button onclick="switchView('projects');document.getElementById('auto-proj-toast')?.remove()" style="padding:5px 12px;background:var(--gold);color:#0e0e0f;border:none;border-radius:5px;cursor:pointer;font-size:11px;font-family:'DM Sans',sans-serif;font-weight:600">View Projects</button>
          <button onclick="document.getElementById('auto-proj-toast')?.remove()" style="padding:5px 12px;background:var(--bg3);color:var(--text2);border:1px solid var(--border2);border-radius:5px;cursor:pointer;font-size:11px;font-family:'DM Sans',sans-serif">Dismiss</button>
        </div>
      </div>
    </div>`;
  document.body.appendChild(toast);
  setTimeout(()=>{toast.style.opacity='0';toast.style.transition='opacity 0.4s';setTimeout(()=>toast.remove(),400);},6000);
}

// ============================================================
//  OTHER MODALS
// ============================================================
function openProjectModal(){
  document.getElementById('p-deal').innerHTML='<option value="">No Deal</option>'+state.deals.map(d=>`<option value="${d.id}">${d.name} — ${d.client}</option>`).join('');
  document.getElementById('project-modal').classList.add('open');
}
function openTaskModal(editId){
  const t=editId?state.tasks.find(x=>x.id===editId):null;
  document.querySelector('#task-modal .modal-title').childNodes[0].nodeValue=t?'Edit Task ':'New Task ';
  document.getElementById('t-project').innerHTML=state.projects.filter(p=>p.status!=='complete'&&!p.archived).map(p=>`<option value="${p.id}" ${t&&t.projectId===p.id?'selected':''}>${p.name}</option>`).join('')||'<option>No active projects</option>';
  document.getElementById('t-assignee').innerHTML=state.team.map(m=>`<option value="${m.id}" ${t&&t.assigneeId===m.id?'selected':''}>${m.name}</option>`).join('');
  document.getElementById('t-title').value=t?t.title:'';
  document.getElementById('t-due').value=t?(t.due||''):'';
  document.getElementById('t-priority').value=t?t.priority:'med';
  document.getElementById('t-status').value=t?t.status:'todo';
  document.getElementById('t-est').value=t?(t.estHours||''):'';
  document.getElementById('task-modal').dataset.editId=editId||'';
  // Show delete button only for admins editing an existing task
  const delWrap=document.getElementById('t-delete-wrap');
  if(delWrap) delWrap.style.display=(auth.role==='admin'&&editId)?'block':'none';
  updateTaskPayPreview();
  document.getElementById('task-modal').classList.add('open');
}
function openEditTaskModal(id){openTaskModal(id);}


function updateTaskPayPreview(){
  const preview=document.getElementById('t-pay-preview');
  if(!preview) return;
  const projectId=document.getElementById('t-project').value;
  const hours=parseFloat(document.getElementById('t-est').value)||0;
  const editId=document.getElementById('task-modal').dataset.editId;

  if(!projectId||!hours){preview.style.display='none';return;}

  // Simulate what the pay would be for this task given the current hours
  const proj=state.projects.find(p=>p.id===projectId);
  const deal=proj?state.deals.find(d=>d.id===proj.dealId):null;
  const pb=deal?deal.buckets.find(b=>b.name==='Production Pool'):null;
  if(!pb){preview.style.display='none';return;}

  const pool=netRev(deal)*pb.pct/100;
  // Calculate total hours for this project, accounting for the edited task
  const siblingHours=state.tasks
    .filter(t=>t.projectId===projectId&&(!editId||t.id!==editId))
    .reduce((s,t)=>s+(t.estHours||0),0);
  const totalH=siblingHours+hours;
  const pay=totalH>0?pool*(hours/totalH):0;
  const shareP=totalH>0?Math.round(hours/totalH*100):0;

  preview.style.display='flex';
  document.getElementById('t-pay-amount').textContent=fmt(pay);
  document.getElementById('t-pay-detail').textContent=`${shareP}% of ${fmt(pool)} pool · ${hours}h / ${totalH}h total`;
}


function closeModal(id){document.getElementById(id).classList.remove('open');}


// ============================================================
//  HELPERS
// ============================================================
function fmt(v){return'$'+Math.round(v).toLocaleString('en-US');}
function statusLabel(s){return{todo:'To Do',progress:'In Progress',review:'In Review',done:'Done'}[s]||s;}
function formatDue(ds){const d=new Date(ds+'T12:00:00'),now=new Date();const diff=Math.round((d-now)/86400000);if(diff<-1)return`${Math.abs(diff)}d ago`;if(diff===-1)return'Yesterday';if(diff===0)return'Today';if(diff===1)return'Tomorrow';if(diff<7)return`${diff}d`;return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});}
function getDueClass(ds){const diff=Math.round((new Date(ds+'T12:00:00')-new Date())/86400000);if(diff<0)return'overdue';if(diff<=3)return'soon';return'';}
function notify(msg){const el=document.getElementById('notif');el.textContent=msg;el.style.display='block';setTimeout(()=>el.style.display='none',2500);}

document.querySelectorAll('.modal-overlay').forEach(el=>{el.addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});});

// Start login — data loads from Supabase after authentication
initLogin();
</script>
</body>
</html>
